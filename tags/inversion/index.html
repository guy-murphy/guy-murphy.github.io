<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>inversion | Weird Scenes Inside The Goldmine</title>
  <meta name="author" content="Guy Murphy">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Weird Scenes Inside The Goldmine"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Weird Scenes Inside The Goldmine" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Weird Scenes Inside The Goldmine</a>, <small>...an obscurely titled development blog.</small></h1>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
      <li><a href="https://github.com/guy-murphy">Github</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title tag">inversion</h2>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-02-05T04:21:48.000Z"><a href="/2015/02/05/Configuring-behaviour-in-Inversion-Part-2/">Feb 5 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/02/05/Configuring-behaviour-in-Inversion-Part-2/">Configuring behaviour in Inversion: Part 2</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Previous: <a href="http://guy-murphy.github.io/2015/01/20/Configuring-behaviour-in-Inversion/" target="_blank" rel="external">Configuring behaviour in Inversion</a></p>
<p>In the last article I talked about the how and why of implementing behaviour configuration in Inversion. When I reviewed the work I surmised that it was a qualified success with some work remaining to do before the matter could be put to bed entirely.</p>
<blockquote>
<p>With the original implementation there was a lot of pressure to inherit from various classes in order to inherit some of their configuration features. This caused a lot of strain on inheritance.</p>
<p>With the move to a common data-structure for configuration we took away pressure from inheriting to gain varying configuration properties.</p>
<p>With the move to predicates as methods extending IConfiguredBehaviour we took pressure away from having to inherit from a particular class in order to pick up it’s condition predicates.</p>
<p>What we didn’t escape was the need to actually use these predicates in a condition, therefore making it desirable to inherit from some classes in order to obtain the checks they perform in their condition.</p>
<p>So this is really a 2 out of 3 in this regard. We have relieved pressure from inheritance in quite a marked way, but there remains an impediment that will require more thought and work.</p>
</blockquote>
<p>The basic mechanism for addressing this wasn’t really the issue, uncertainty was where such a mechanism should reside.</p>
<blockquote>
<p>The issue isn’t implementing the lookup of predicate strategies, it can be as simple as a dictionary of lambdas, the cause for concern is where to define this, and where to inject it. Which object should be responsible for maintaining this lookup? It probably fits well enough on the context, but it would require the context to hold implementation details of behaviours, and I want to think about that some.</p>
</blockquote>
<p>This follow-up article will talk about how progress was made with this remaining area extending selection strategies for behaviours, with a focus on “open for extension but closed for modification”.</p>
<h2 id="Selection_criteria">Selection criteria</h2>
<p>One of the concepts that was firming up was the idea of <em>selection criteria</em> which was a predicate acting upon a configuration and event to determine if a behaviours condition was a match. Last time these were implemented as extension methods for <code>IConfiguredBehaviour</code> which were nice in that it was easy to add new selection criteria without having to change anything. The problem remaining with them was that conditions still needed to <em>know about and use them</em>. The <em>uses-a</em> relationship between behaviours and their selection criteria was not open for easy extension. The use of selection criteria was “hard coded”, and required use of inheritance to override, which is something we were trying to avoid as we prefer “composition over inheritance for application behaviour”.</p>
<p>By the end of the last piece we had a reasonably firm idea that we wanted to inject selection criteria into behaviours as strategies to be used by conditions without the conditions knowing about the strategies other than their general shape and how to use them. The details or purpose of a strategy not being important to a behaviour which is just concerned whether or not its selection criteria pass or fail.</p>
<p>So the first order of business was to make selection criteria a thing:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">bool</span> <span class="title">SelectionCriteria</span>(IConfiguration config, IEvent ev);</div></pre></td></tr></table></figure>

<p>A function that acts upon an <code>IConfiguration</code> and <code>IEvent</code>, and returns a <code>bool</code>. This allows us to move our use of extension methods to lambda expressions which are easy to store and inject:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(config, ev) =&gt; ev.HasParams(config.GetNames(<span class="string">"event"</span>, <span class="string">"has"</span>))</div></pre></td></tr></table></figure>

<p>If a behaviour as part of it’s configuration were injected with a set of these <code>SelectionCriteria</code> a behaviour during it’s condition check could simply check that each of these criteria returns <code>true</code>. We would be able to effectively inject a behaviours condition implementation.</p>
<p>That bit was easy… But how do we decide what to inject into a behaviour?</p>
<h2 id="Stuff_what_selects_stuff_what_selects_stuff">Stuff what selects stuff what selects stuff</h2>
<p>Then I fell off a conceptual cliff.</p>
<p>How to decide what stuff to inject?.. I spent most of a morning trying to formalise an expression of <em>“stuff what selects stuff what selects stuff”</em> that didn’t make me sound like a cretin. I’d walk into my garden and sit, think of a compositional pattern, run to my studio and find I’d laid down a bunch of things that all sounded the same the distinctions between which seemed very arbitrary.</p>
<p>The darkest 15 minutes of that morning was the brief period when I considered using behaviours to configure behaviours, and started seeing behaviours all the way down.</p>
<p>The reason for my anxiety is I was becoming convinced that I was starting to commit a cardinal sin of application architects which is the sin of the <a href="composition over inheritance for application behaviour">Golden Hammer</a>.</p>
<blockquote>
<p>The concept known as the law of the instrument, Maslow’s hammer, Gavel or a golden hammer[a] is an over-reliance on a familiar tool; as Abraham Maslow said in 1966, “I suppose it is tempting, if the only tool you have is a hammer, to treat everything as if it were a nail.”</p>
</blockquote>
<p>The pull of the Golden Hammer for the architect is almost inexorable as the core concern of the architect is too look for common patterns of structure and behaviour, to move from a diverging variety of abstractions to converging use of abstractions. When you get a hold of an implementation of a pattern that is producing good results for you, it is very hard to avoid seeing that pattern everywhere.</p>
<p>It’s also one of the primary mechanisms by which we turn our architectural cathedrals into slag heaps. It’s destructive because it represents the building of an increasingly strong bias about the applicability of an abstraction, that leads to poor judgment and the inappropriate application of abstractions. I call it a sin because its seductive, difficult to avoid, is always recurring, and has bad consequences in the long term while feeling  good in the short term.</p>
<p>I knew I was seeing the modeling of <em>condition/action</em> pairs everywhere, that this was part of a protracted phase I’m going through, and that I was vulnerable to the hubris of the Golden Hammer.</p>
<p>I also knew that some patterns are foundational and do have broad applicability. I don’t find the promiscuous use of <em>key/value</em> pairs or <code>IEnumerable&lt;T&gt;</code> anxiety provoking use of a Golden Hammer, and <em>condition/action</em> is as foundational as an <code>if</code> statement.</p>
<p>The rest of the morning was spent giving a performance of Gollum (from Lord of the Rings) as an application architect having an argument with himself about the semantics of <em>stuff</em> and <em>select</em> while anxious about getting hit by a hammer.</p>
<h2 id="An_optional_extension_of_the_existing_framework">An optional extension of the existing framework</h2>
<p>I broke out of this neurotic circular argument with myself by deciding that I would implement the abstraction of <em>stuff what selects stuff what selects stuff</em> as a straight-up extension of the existing framework without altering any of the existing types or their implementations. If I could do this then if it became apparent that the abstraction or its implementation was ill-conceived (as it felt it might be) it could remain an odd appendix of an experiment that could be removed at some point without any negative impact on the broader framework… If the extension sucked it simply wouldn’t get used… And I wouldn’t write about it.</p>
<p>It’s worth drawing attention to this benefit of implementing features as extensions.</p>
<p>When we talk about extensibility being good, and consider things like open for extension but closed for modification we tend to view it from the angle of this concern making the writing of extensions easier. The benefit that doesn’t get considered perhaps quite as much is that this approach of extending what is without modifying it is also a strategy for mitigating risk. It makes it easier to move away from such extensions if they’re poorly conceived with reduced consequence to the rest of the framework.</p>
<p>This is one of the goals of Inversion. Development by extension, with an ability to evolve and move poorly conceived abstractions toward increasingly better abstractions. The ability to experiment which is to say, try out different approaches, needs to be facilitated or our systems can’t evolve and we will never get past either cycles of system rewrites, or legacies of poor judgment which we can’t escape. Extensibility in this way is a strategy for easing the paying down of technical debt in the future or lowering the interest rates for technical debt if you like.</p>
<h2 id="Say_what_you_see">Say what you see</h2>
<p>So the worst case scenario was an odd bit of code that Guy wrote one day that Adam laughed at. There wasn’t a risk of reverting anything, and my anxiety was removed, making clear quite a short and easy path to a solution.</p>
<p>Once I decided I was losing the war of semantics and came to terms with my caveman-like expression of the problem, it was easy to start breaking it down.</p>
<p><em>stuff that selects stuff that selects stuff</em></p>
<p>I know how primitive that is, but it’s what I had… We’re going to look at a configuration, and on the basis of what we see there, we’re going to pick a bunch of selection criteria that a behaviour will use in its condition.</p>
<p>We have the last bit, the <code>SelectionCriteria</code>. The first bit is a match that can be expressed as a predicate acting upon an <code>IConfiguration</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// stuff what selects, stuff what selects stuff</span></div><div class="line">(Predicate&lt;IConfiguration&gt; match, SelectionCriteria criteria)</div></pre></td></tr></table></figure>

<p>This concern pivots around a behaviours configuration with selection criteria being picked on the basis of the configurations characteristics. So if for example a behaviour configuration contains the tuple <code>(&quot;event&quot;, &quot;has&quot;)</code> the predicate that matches this would be associated with the <code>SelectionCriteria</code> to act on this as part of the behaviours condition.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">match: (config) =&gt; config.Has(<span class="string">"event"</span>, <span class="string">"has"</span>),</div><div class="line">criteria: (config, ev) =&gt; ev.HasParams(config.GetNames(<span class="string">"event"</span>, <span class="string">"has"</span>))</div></pre></td></tr></table></figure>

<p>Struggling with semantics as I was, I decided to simply call this association of two predicates a <em>case</em>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> IPrototypeCase {</div><div class="line">    Predicate&lt;IConfiguration&gt; Match { <span class="keyword">get</span>; }</div><div class="line">    SelectionCriteria Criteria { <span class="keyword">get</span>; }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>This picking of selection criteria consults only the configuration and given that the behaviour configuration is immutable, this picking can take place when the configuration is instantiated, and would only need only need to expose the selection criteria that had been picked. This was done by extending <code>IConfiguration</code> thus:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> IPrototype : IConfiguration {</div><div class="line">    IEnumerable&lt;SelectionCriteria&gt; Criteria { <span class="keyword">get</span>; }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>Similarly constrained in terms of semantic inspiration this extension of the behaviours configuration was called a <em>prototype</em>. I was thinking in terms of <a href="http://en.wikipedia.org/wiki/Prototype-based_programming" target="_blank" rel="external">prototype-based programming</a> which I’d had some success in the past with classification, inheritance, and overriding of relational data, and was thinking of a behaviours configuration tuples with associated functions as prototypes. Not the best example of prototypes, but vaguely in the ballpark, I needed to call it something and had lost patience with my own semantic angst. I was ready to call this thing “Nigel” if it allowed me to move on, and <code>Prototype</code> kind of fit.</p>
<p>A prototype is a configuration that expresses selection criteria that have been chosen for that configuration.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> ConcurrentDictionary&lt;<span class="keyword">string</span>, IPrototypeCase&gt; NamedCases = <span class="keyword">new</span> ConcurrentDictionary&lt;<span class="keyword">string</span>, IPrototypeCase&gt;(); </div><div class="line">  </div><div class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> ImmutableHashSet&lt;SelectionCriteria&gt; _criteria; </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="title">Prototype</span>(</div><div class="line">        IEnumerable&lt;IConfigurationElement&gt; config, </div><div class="line">        IEnumerable&lt;IPrototypeCase&gt; cases</div><div class="line">) : <span class="title">base</span>(config) {</div><div class="line">    <span class="keyword">var</span> builder = ImmutableHashSet.CreateBuilder&lt;SelectionCriteria&gt;();</div><div class="line">    <span class="keyword">foreach</span> (IPrototypeCase @<span class="keyword">case</span> <span class="keyword">in</span> cases) {</div><div class="line">        <span class="keyword">if</span> (@<span class="keyword">case</span>.Match(<span class="keyword">this</span>)) builder.Add(@<span class="keyword">case</span>.Criteria);</div><div class="line">    }</div><div class="line">    _criteria = builder.ToImmutable();</div><div class="line">}</div></pre></td></tr></table></figure>

<p>This allows us to establish a base set of selection criteria out of the box, that is easy for application developers to override, as seen in <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Process/Behaviour/Prototype.cs" target="_blank" rel="external">Prototype</a> thus:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">NamedCases[<span class="string">"event-has"</span>] = <span class="keyword">new</span> Case(</div><div class="line">    match: (config) =&gt; config.Has(<span class="string">"event"</span>, <span class="string">"has"</span>),</div><div class="line">    criteria: (config, ev) =&gt; ev.HasParams(config.GetNames(<span class="string">"event"</span>, <span class="string">"has"</span>))</div><div class="line">);</div><div class="line">NamedCases[<span class="string">"event-match"</span>] = <span class="keyword">new</span> Case(</div><div class="line">    match: (config) =&gt; config.Has(<span class="string">"event"</span>, <span class="string">"match"</span>),</div><div class="line">    criteria: (config, ev) =&gt; ev.HasParamValues(config.GetMap(<span class="string">"event"</span>, <span class="string">"match"</span>))</div><div class="line">);</div><div class="line">NamedCases[<span class="string">"context-has"</span>] = <span class="keyword">new</span> Case(</div><div class="line">    match: (config) =&gt; config.Has(<span class="string">"context"</span>, <span class="string">"has"</span>),</div><div class="line">    criteria: (config, ev) =&gt; ev.Context.HasParams(config.GetNames(<span class="string">"context"</span>, <span class="string">"has"</span>))</div><div class="line">);</div><div class="line">NamedCases[<span class="string">"context-match"</span>] = <span class="keyword">new</span> Case(</div><div class="line">    match: (config) =&gt; config.Has(<span class="string">"context"</span>, <span class="string">"match"</span>),</div><div class="line">    criteria: (config, ev) =&gt; ev.Context.HasParamValues(config.GetMap(<span class="string">"context"</span>, <span class="string">"match"</span>))</div><div class="line">);</div><div class="line"><span class="comment">// and so om</span></div></pre></td></tr></table></figure>

<p>We can then see this being <em>used</em> in <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Process/Behaviour/PrototypedBehaviour.cs" target="_blank" rel="external">PrototypedBehaviour</a>:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">Condition</span>(IEvent ev, IProcessContext context) { </div><div class="line">    <span class="keyword">return</span> <span class="keyword">base</span>.Condition(ev, context) && </div><div class="line">    <span class="keyword">this</span>.Prototype.Criteria.All(criteria =&gt; criteria(<span class="keyword">this</span>.Configuration, ev)); </div><div class="line">}</div></pre></td></tr></table></figure>

<p>This now forms a solid base class that is open for extension. We have relieved the pressure from having to inherit from a particular class in order to inherit its selection criteria which are now picked at during the behaviours instantiation, based upon the shape of the behaviours configuration. This extension is implemented as an extension of the behaviours configuration which is the focus of its concern and action.</p>
<p>The added benefit of this is because only applicable selection criteria are picked for a behaviour, we’re never running redundant selection criteria as part of a condition. This in turn means we can grow our implementations of selection criteria without concern the concern of a performance impact from redundant checks. Because behaviours are singletons, this selection process takes place just once for each behaviour, so it scales nicely as the surface area of our selection criteria increases over time.</p>
<p>Another way of thinking of this injection of strategies, is to compose or “mixin” at run-time applicable implementation details based upon configuration.</p>
<p>A side benefit of this work apart from making it easier to extend behaviours without having to introduce new types, is that we picked up an extra 5% to 10% performance with the loss of redundant selection criteria.</p>
<h2 id="The_abuse_of_static_members_and_future_work">The abuse of static members and future work</h2>
<p>The maintenance of <code>NamedCases</code> as a static member of <code>Prototype</code> is a bad thing. Initialising the default cases from the <code>Prototype</code> static constructor is a doubly bad thing. Lastly, this is mutable data being maintained as a static member, so I’m going straight to hell for sure.</p>
<p>It’s not because “global state is bad”, because it’s not. The notion that global state is bad requires ignoring the use of a database, file-system, configuration, service container, or getting the time from the system. The maintenance of <em>non-global</em> state globally is bad, and I’m not sure to what degree it can be said that these default cases are global.</p>
<p>In maintaining the cases like this I’m needlessly tying the default implementation of selection criteria to the <code>Prototype</code> class, and I wonder if it should be associated with the behaviours type. I’m not sure yet.</p>
<p>The strongest case for not maintaining the named cases as a static is because we don’t need to.</p>
<p>Behaviours are used as singletons so these cases can sit as instance members of either the prototype of a behaviour or the behaviour itself, but I’m not entirely sure where I want to place this concern yet, and at the moment I’m trying to impact prior work as little as possible.</p>
<p>The cases are injected via this constructor:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="title">Prototype</span>(</div><div class="line">    IEnumerable&lt;IConfigurationElement&gt; config, </div><div class="line">    IEnumerable&lt;IPrototypeCase&gt; cases</div><div class="line">)</div></pre></td></tr></table></figure>

<p>So I can easily kill the static members and inject the prototype from the behaviours constructor.</p>
<p>As is probably clear from this write-up, I struggled conceptually a couple of times through this process. The simplest possible thing at this point is not just desirable, but needful, and the simplest possible way of injecting a prototypes cases is:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="title">Prototype</span>(IEnumerable&lt;IConfigurationElement&gt; config): </div><div class="line">    <span class="title">this</span>(config, Prototype.NamedCases.Values) {}</div></pre></td></tr></table></figure>

<p>In the last post on behaviour configuration I stopped having solved two out of three parts of a problem. If I had continued without time to simply think the abstraction over I would have started making things worse rather than better. I find it personally crucially important to recognise when I am approaching this point. Much of my worst code has been done past the point when I should have simply stopped, regrouped my mental faculties, gained some perspective, sought outside opinions, and contemplated my options weighing their pros and cons for more than 2 minutes.</p>
<p>Invariably when I continue past where I should have prudently stopped it has involved my own vanity and a concern about what other developers and architects would think of me. Being aware of one or more deficiencies in my code, often aware that I am at risk of running afoul of one or more anti-patterns, I over-extend myself because I fear being called a “bad developer”… There’s a self defeating vicious cycle in this… I have never, nor am I ever likely to finish a piece of work that is perfect. Every single piece of work I complete will be flawed, and if I don’t come to terms with that I will over extend my self each time and turn good work into bad.</p>
<p>When I accept that my work will iteratively improve a situation but at each iteration be left with flaws, I can then look to recognise and manage those flaws. I can establish my contingencies, and I can plan a safe and pragmatic route of improving abstractions.</p>
<p>The remaining problem of being able to inject selection criteria into behaviours on the basis of their configuration in a manner that other developers can easily extend to meet their own needs, and without changing the preexisting framework has been accomplished. There is the uncomfortable hang-nail of <code>NamedCases</code> being a static member, but it’s safe where it’s parked and easy to move away from without negative impact. So this is where this iteration should end. I need to now let this abstraction bed in, ensure it doesn’t have any unintended consequences before anointing it and baking it into the framework any further.</p>

      
    </div>
    <footer>
      
        
        
      
      
  
  <div class="tags">
    <a href="/tags/inversion/">inversion</a>, <a href="/tags/patterns/">patterns</a>
  </div>

      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-01-20T11:41:30.000Z"><a href="/2015/01/20/Configuring-behaviour-in-Inversion/">Jan 20 2015</a></time>
      
      
  
    <h1 class="title"><a href="/2015/01/20/Configuring-behaviour-in-Inversion/">Configuring behaviour in Inversion</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Or, <em>Experiments with black-box development.</em></p>
<p><strong>update</strong>: <a href="http://guy-murphy.github.io/2015/02/05/Configuring-behaviour-in-Inversion-Part-2/" target="_blank" rel="external">Part 2</a> now follows on with the “further work” outlined toward the end of this article.</p>
<p>I’ve recently overhauled both the way that Inversion configures behaviours and the way in which that configuration is acted on as selection criteria when determining which behaviours should respond to an event. I thought I’d write this up as it keeps the small group of developers engaged with this work up-to-date, provides some informal documentation, and provides an illustration of a couple of Inversions design goals.</p>
<h2 id="You_need_to_know_where_the_goal_is_in_order_to_score">You need to know where the goal is in order to score</h2>
<p><em>TL;DR Make things as bendy, fast and easy to change as possible… Check that you are.</em></p>
<p>Inversion might have been labeled <em>Application stack number seven</em> as it sits on the back of six previous incarnations the first of which started in 2004 as an experiment in implementing MVC on the .NET platform, the decedent of which went live into production in 2006 where is remains to this day. Two other slightly earlier but very close incarnations of Inversion have gone into production in 2012 and 2014, but by this time the point of interest had moved well past MVC to playing with ideas of behavioural composition as a means of meeting cross-cutting concerns normally addressed by <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming" target="_blank" rel="external">AoP</a>.</p>
<p>So Inversion is merely the most recent of a series of application stacks experimenting with a handful of core ideas some of which are more developed than others at this point, but each of which should show progression rather than regression over time.</p>
<p>My experience tells me that any piece of development spanning more than a handful of weeks quickly starts accumulating the risk of it’s initial goals being diluted and then eventually forgotten. It is important then to remind ourselves what it is in broad terms we’re trying to obtain from a system, and then to review our activity and ensure we’re actually meeting those goals whether formally or informally.</p>
<p>This is a summary of some of Inversions goals :- </p>
<ul>
<li>Black-box components</li>
<li>Configuration as resource distinct from application</li>
<li>Favouring composition over inheritance for application behaviour</li>
<li>Small footprint micro-framework</li>
<li>Single responsibility</li>
<li>Extensibility, DIY</li>
<li>Substitution, <em>Plugability</em></li>
<li>Inversion of Control</li>
<li>Testability</li>
<li>Portability</li>
<li>Conventions for state</li>
<li>Speed</li>
</ul>
<p>Behaviour configuration will have a large impact on Inversion and will almost certainly add a distinct flavour to the frameworks usage for better or for worse, so it’s important once we’re done that we review our goals and ensure they’re being advanced and not diminished.</p>
<h2 id="Finding_a_common_abstraction_for_behaviour_configuration">Finding a common abstraction for behaviour configuration</h2>
<p><em>TL;DR Tuples.</em></p>
<p>Inversion is in large part a composition of <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Process/Behaviour/IProcessBehaviour.cs" target="_blank" rel="external">IProcessBehaviour</a> objects. A set of condition/action pairs. The relevant portion of the interface being:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// snipped out some members and comments for clarity</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> IProcessBehaviour {</div><div class="line">    <span class="keyword">string</span> RespondsTo { <span class="keyword">get</span>; }</div><div class="line">    <span class="keyword">bool</span> Condition(IEvent ev, IProcessContext context);</div><div class="line">    <span class="keyword">void</span> Action(IEvent ev, IProcessContext context);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>When we <code>context.Fire(event)</code> we pass the event to the condition of each behaviour registered with the context in turn. If the condition returns true, that behaviours action is executed on the context.</p>
<p>Over time we find a lot of common activity taking place in conditions.</p>
<ul>
<li>Does the context have any of these parameters?</li>
<li>Do these parameters and values exist on the context?</li>
<li>Do they exist on the event?</li>
<li>Do we have these keys in the contexts control-state?</li>
</ul>
<p>For want of a better phrase we call this the <em>selection criteria</em> of the behaviour.</p>
<p>So we quite naturally start to refactor common selection criteria into base classes. We also start to push out the specification of selection criteria to configuration of the behaviour.</p>
<p>In Inversions previous incarnation the expression of config for selection had gotten <a href="https://github.com/guy-murphy/conclave-public/blob/master/Conclave.Web/Behaviour/WebActionBehaviour.cs" target="_blank" rel="external">quite out of hand</a>. Each category of test ended up with its own data-structure both to configure and drive that test.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ImmutableList&lt;<span class="keyword">string</span>&gt; _includedAllControlStates;</div><div class="line"><span class="keyword">private</span> ImmutableList&lt;<span class="keyword">string</span>&gt; _nonIncludedControlStates;</div><div class="line"><span class="keyword">private</span> ImmutableList&lt;<span class="keyword">string</span>&gt; _includedAllParameters;</div><div class="line"><span class="keyword">private</span> ImmutableList&lt;<span class="keyword">string</span>&gt; _nonIncludedParameters;</div><div class="line"><span class="keyword">private</span> ImmutableDictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; _matchingAllParams;</div><div class="line"><span class="keyword">private</span> ImmutableDictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; _nonMatchingAllParams;</div></pre></td></tr></table></figure>

<p>This config would be injected in the constructor by the service container, and be acted upon by the behaviours condition.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Condition</span>(IEvent ev, IProcessContext context) {</div><div class="line">    <span class="keyword">bool</span> parmsAndValues = <span class="keyword">this</span>.MatchingAllParameters.All(p =&gt; </div><div class="line">        context.Params.Contains(p) && </div><div class="line">        context.Params[p.Key] == p.Value</div><div class="line">    );</div><div class="line">    <span class="keyword">bool</span> notParmsAndValues = <span class="keyword">this</span>.NonMatchingAllParameters.All(p =&gt; </div><div class="line">        context.Params.Keys.Contains(p.Key) && </div><div class="line">        context.Params[p.Key] != p.Value</div><div class="line">    );</div><div class="line">    <span class="keyword">bool</span> controlStates = <span class="keyword">this</span>.IncludedAllControlStates.All(p =&gt; </div><div class="line">        context.ControlState.Keys.Contains(p)</div><div class="line">    );</div><div class="line">    <span class="keyword">bool</span> notParms = <span class="keyword">this</span>.NonIncludedParameters.All(p =&gt; </div><div class="line">        !context.Params.Keys.Contains(p)</div><div class="line">    );</div><div class="line">    <span class="keyword">bool</span> notControlStates = <span class="keyword">this</span>.NonIncludedControlStates.All(p =&gt; </div><div class="line">        !context.ControlState.Keys.Contains(p)</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">return</span> </div><div class="line">        <span class="keyword">base</span>.Condition(ev, context) && </div><div class="line">        parms && </div><div class="line">        parmsAndValues && </div><div class="line">        notParmsAndValues && </div><div class="line">        controlStates && </div><div class="line">        notParms && </div><div class="line">        notControlStates;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>It worked, but it wasn’t extensible in that to extend the functionality required adding more and more data-structures, with less and less common purpose. It put a lot of pressure on inheritance to both pick up config you were interested in, along with it’s condition checks. It was riddled with assumptions which you either accepted or were left with no functionality except a bespoke implementation. Special little snowflakes everywhere, which is the opposite of what is being attempted.</p>
<p>It worked in that it allowed specifying behaviour selection criteria from config but the expression of these configs in Spring.NET or in code, was painful, hard to understand, and messy. Worst it was leaking implementation details from the behaviours across their interface.</p>
<p>So I started playing around with something along the lines of <code>IDictionary&lt;string, IDictionary&lt;string, IDictionary&lt;string, IList&lt;string&gt;&gt;&gt;&gt;</code>, which again kind of worked. It was an improvement in that the previous configurations for selection criteria could all pretty much be expressed with the one data-structure. The data-structure however was messy, and difficult to express in configuration.</p>
<p>Next I started playing with a structure something like, <code>MultiKeyValue&lt;string, string, string, string&gt;</code> which finally started to feel in some way rational and self contained. I happened to be reading a piece comparing the efficiency of hashcodes between key-value pairs and tuples which made obvious a very short step to <code>Configuration.Element : Tuple&lt;int, string, string, string, string&gt;</code>.</p>
<p>The class <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Process/Configuration.cs" target="_blank" rel="external">Inversion.Process.Configuration</a> represents a set of ordered elements, or a relation of tuples expressing <code>(ordinal, frame, slot, name, value)</code>. This is a very expressive structure, and with LINQ easy and efficient to query in lots of different ways.</p>
<p>The resulting configuration is easy to express in code, and encourages a declarative rather than fluent style.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">Naiad.ServiceContainer.Instance.RegisterService(<span class="string">"test-behaviours"</span>,</div><div class="line">    container =&gt; {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> List&lt;IProcessBehaviour&gt; {</div><div class="line">            <span class="keyword">new</span> MessageTraceBehaviour(<span class="string">"*"</span>, </div><div class="line">                <span class="keyword">new</span> Configuration.Builder {</div><div class="line">                    {<span class="string">"event"</span>, <span class="string">"match"</span>, <span class="string">"trace"</span>, <span class="string">"true"</span>}</div><div class="line">                }</div><div class="line">            ),</div><div class="line">            <span class="keyword">new</span> ParameterisedSequenceBehaviour(<span class="string">"test"</span>, </div><div class="line">                <span class="keyword">new</span> Configuration.Builder {</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"bootstrap"</span>},</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"parse-request"</span>},</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"work"</span>},</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"view-state"</span>},</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"process-views"</span>},</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"render"</span>}</div><div class="line">                }</div><div class="line">            ),</div><div class="line">            <span class="keyword">new</span> ParameterisedSequenceBehaviour(<span class="string">"work"</span>, </div><div class="line">                <span class="keyword">new</span> Configuration.Builder {</div><div class="line">                    {<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test1"</span>},</div><div class="line">                    {<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test2"</span>},</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"work-message-one"</span>, <span class="string">"trace"</span>, <span class="string">"true"</span>}, </div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"work-message-two"</span>, <span class="string">"trace"</span>, <span class="string">"true"</span>}</div><div class="line">                }</div><div class="line">            ),</div><div class="line">            <span class="keyword">new</span> ParseRequestBehaviour(<span class="string">"parse-request"</span>),</div><div class="line">            <span class="keyword">new</span> BootstrapBehaviour(<span class="string">"bootstrap"</span>, </div><div class="line">                <span class="keyword">new</span> Configuration.Builder {</div><div class="line">                    {<span class="string">"context"</span>, <span class="string">"set"</span>, <span class="string">"area"</span>, <span class="string">"default"</span>},</div><div class="line">                    {<span class="string">"context"</span>, <span class="string">"set"</span>, <span class="string">"concern"</span>, <span class="string">"default"</span>},</div><div class="line">                    {<span class="string">"context"</span>, <span class="string">"set"</span>, <span class="string">"action"</span>, <span class="string">"default"</span>},</div><div class="line">                    {<span class="string">"context"</span>, <span class="string">"set"</span>, <span class="string">"appPath"</span>, <span class="string">"/web.harness"</span>}</div><div class="line">                }</div><div class="line">            ),</div><div class="line">            <span class="keyword">new</span> ViewStateBehaviour(<span class="string">"view-state"</span>),</div><div class="line">            <span class="keyword">new</span> ProcessViewsBehaviour(<span class="string">"process-views"</span>, </div><div class="line">                <span class="keyword">new</span> Configuration.Builder {</div><div class="line">                    {<span class="string">"config"</span>, <span class="string">"default-view"</span>, <span class="string">"xml"</span>}</div><div class="line">                }</div><div class="line">            ),</div><div class="line">            <span class="keyword">new</span> RenderBehaviour(<span class="string">"render"</span>),</div><div class="line">            <span class="keyword">new</span> JsonViewBehaviour(<span class="string">"json::view"</span>, <span class="string">"text/json"</span>),</div><div class="line">            <span class="keyword">new</span> XmlViewBehaviour(<span class="string">"xml::view"</span>, <span class="string">"text/xml"</span>),</div><div class="line">            <span class="keyword">new</span> XsltViewBehaviour(<span class="string">"xslt::view"</span>, <span class="string">"text/xml"</span>),</div><div class="line">            <span class="keyword">new</span> XsltViewBehaviour(<span class="string">"xsl::view"</span>, <span class="string">"text/html"</span>),</div><div class="line">            <span class="keyword">new</span> StringTemplateViewBehaviour(<span class="string">"st::view"</span>, <span class="string">"text/html"</span>)</div><div class="line">        };</div><div class="line">    }</div><div class="line">);</div></pre></td></tr></table></figure>

<p>Not the best notational representation ever of configuration, but not the worst, a definite improvement, and something it’s felt one can become comfortable with. It’s certainly a very concise configuration of a swathe of behaviour. </p>
<p>This also is not the primary means of configuration. This is showing the configuration of <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Naiad/ServiceContainer.cs" target="_blank" rel="external">Naiad</a> which is a toy service container Inversion provides suitable for use in unit tests. The above is the <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Web.Tests/Behaviour/ViewPipelineTests.cs" target="_blank" rel="external">configuration of a test</a>.</p>
<p>A good friend and former colleague (Adam Christie) is getting good results from the prototype of a service container called <em>Pot</em>, intended to replace the use of Spring.NET. Until that matures over the coming months, Spring.NET is the favoured service container for Inversion. This doesn’t stop you from from using whichever service container takes your fancy as <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Process/IServiceContainer.cs" target="_blank" rel="external">IServiceContainer</a> shows, Inversions own expectations of a service container are minimal. </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> IServiceContainer : IDisposable {</div><div class="line">    T GetService&lt;T&gt;(<span class="keyword">string</span> name) <span class="keyword">where</span> T: class;</div><div class="line">    <span class="keyword">bool</span> ContainsService(<span class="keyword">string</span> name);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>If you can honour that interface (and you can) with your service container, Inversion wont know any difference.</p>
<p>What I mean when I say Spring.NET is the favoured service container is that out of all the possibilities, Spring.NET is what I happen to be focused on as a baseline.</p>
<h2 id="Acting_on_configuration_for_conditions">Acting on configuration for conditions</h2>
<p><em>TL;DR LINQ</em></p>
<p><a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Process/Behaviour/BehaviourConditionPredicates.cs" target="_blank" rel="external">BehaviourConditionPredicates</a> provides a bunch of predicates as extension methods that take the form:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">ContextMatchesAnyParamValues</span>(<span class="keyword">this</span> IConfiguredBehaviour self, IProcessContext ctx) {</div><div class="line">    IEnumerable&lt;IConfigurationElement&gt; elements = self.Configuration.GetElements(<span class="string">"context"</span>, <span class="string">"match-any"</span>);</div><div class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">foreach</span> (IConfigurationElement element <span class="keyword">in</span> elements) {</div><div class="line">        i++;</div><div class="line">        <span class="keyword">if</span> (ctx.HasParamValue(element.Name, element.Value)) <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> i == <span class="number">0</span>; <span class="comment">// there was no match specified</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>Which illustrates extending <code>IConfiguredBehaviour</code> for whatever condition predicates are useful over time, without having to modify <code>IConfiguredBehaviour</code> or <code>Configuration</code>. We establish our own convention of tuples, and act on them. In the above example we’re extracting elements from the configuration  that have the frame and slot <code>{&quot;context&quot;, &quot;match-any&quot;}</code> which drops out the tuples:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">{<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test1"</span>},</div><div class="line">{<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test2"</span>}</div></pre></td></tr></table></figure>

<p>We check the context for the <code>name</code> and <code>value</code> of each tuple with <code>ctx.HasParamValue(element.Name, element.Value)</code>. </p>
<p>You’re always free to write the conditions for your behaviours in whatever way you need. What we see here is only an illustration of how I happen to be tackling it.</p>
<h2 id="Expressing_tuples_as_XML">Expressing tuples as XML</h2>
<p><em>TL;DR Just read four nodes deep and call them tuple elements.</em></p>
<p>If you step back from XML a moment and consider it simply as an expression of a tree of nodes, there’s a trick you can pull with reading a tree of nodes as tuples which is a little novel in this context but which we take for granted when working with relational databases. That is databases that focus on the grouping of tuples into collections which we call relations, or more commonly tables… I’ll confess to that piece of conceit straight-away. I happened to be doing some reading on working with sets of tuples and ran across the fact that the <em>relational</em> in “relational database” refers to the fact that it’s the set of tuples that are a <em>relation</em>, commonly called table, not any association between tables as you might expect from the term. Was novel to me, and I now obviously like flaunting the term… Back on topic…</p>
<p>Given that our configuration is made up of a set of tuples the elements of which we’re calling <code>(frame, slot, name, value)</code>, consider the following XML:-</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">    <span class="tag">&lt;<span class="title">context</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">match-any</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">action</span>&gt;</span>test1<span class="tag">&lt;/<span class="title">action</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">action</span>&gt;</span>test2<span class="tag">&lt;/<span class="title">action</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">match-any</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">context</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">fire</span>&gt;</span>                  </div><div class="line">        <span class="tag">&lt;<span class="title">work-message-one</span> <span class="attribute">trace</span>=<span class="value">"true"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">work-message-two</span> <span class="attribute">trace</span>=<span class="value">"true"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">fire</span>&gt;</span></div><div class="line">...</div></pre></td></tr></table></figure>

<p>If we read that one node at a time, and with each node copy it as an element of our tuple, our first tuple builds up thus:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">context     =&gt;  {<span class="string">"context"</span>}</div><div class="line">match-any   =&gt;  {<span class="string">"context"</span>, <span class="string">"match-any"</span>}</div><div class="line">action      =&gt;  {<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>}</div><div class="line">test1       =&gt;  {<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test1"</span>}</div></pre></td></tr></table></figure>

<p>And we have our first tuple. Now if we were reading results from a database, we’d not be surprised if the next value <code>value2</code> were preceded by the same elements, as they are unchanged. So our second tuple is <code>{&quot;context&quot;, &quot;match-any&quot;, &quot;action&quot;, &quot;test2&quot;}</code>. In this way we can read that XML snippet as:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">{<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test1"</span>},</div><div class="line">{<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test2"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"work-message-one"</span>, <span class="string">"trace"</span>, <span class="string">"true"</span>}, </div><div class="line">{<span class="string">"fire"</span>, <span class="string">"work-message-two"</span>, <span class="string">"trace"</span>, <span class="string">"true"</span>}</div></pre></td></tr></table></figure>

<p>Which is exactly what we’re after. We can now define a set of tuples very expressively and in an extensible manner with XML, we now just need to hook this up with Spring.</p>
<h2 id="Extending_Spring-NET_configuration">Extending Spring.NET configuration</h2>
<p><em>TL;DR Was much easier than expected.</em></p>
<p>I’ve been using Spring.NET since 2006 as the backbone of most applications I’ve built. It’s something of a behemoth, and the reality is I’ve only really ever used a very thin slice of its features. I’ve always been comforted by the fact that there’s a solution to most problems with Spring and if I needed to I could extend my way out of a tight space, despite the fact I’ve never had much call to.</p>
<p>One of the things I’ve always wanted to do was extend and customise Spring xml configuration. If you’re working with Spring and xml configs one of the costs is you’re going to end up with a lot of configuration and it’s got a fair few sharp edges to it. After having a stab at it I can only say I wish I’d done it years ago as it was far less involved than I expected.</p>
<p>The relevant documentation for this is <a href="http://springframework.net/docs/1.1.2/reference/html/extensible-xml.html" target="_blank" rel="external">Appendix B. Extensible XML authoring</a> which lays out in pretty straight-forward terms what needs to be done. From this we produce:-</p>
<h3 id="An_XSD_schema_describing_our_extension_of_the_Spring_config">An XSD schema describing our extension of the Spring config</h3>
<ul>
<li><a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Spring/behaviour.xsd" target="_blank" rel="external">behaviour.xsd</a> </li>
</ul>
<p>Which provides the schema for our config extension, and most importantly associates it with a namespace. This is our “what”.</p>
<p>There a small gotcha here. You need to go to the file properties and set <em>Build action</em> to <em>Embedded resource</em>, as you’re schema needs to be embedded in the assembly for it to be used.</p>
<h3 id="A_parser_for_our_namespace">A parser for our namespace</h3>
<ul>
<li><a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Spring/BehaviourNamespaceParser.cs" target="_blank" rel="external">BehaviourNamespaceParser</a></li>
</ul>
<p>Which is responsible for mapping individual xml elements to the unit of code that will process them. For each xml element you register its handler, thus:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.RegisterObjectDefinitionParser(<span class="string">"view"</span>, <span class="keyword">new</span> ViewBehaviourObjectDefinationParser());</div></pre></td></tr></table></figure>

<p>This is our link between “what” and “how”.</p>
<h3 id="An_object_definition_parser">An object definition parser</h3>
<ul>
<li><a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Spring/BehaviourObjectDefinationParser.cs" target="_blank" rel="external">BehaviourObjectDefinationParser</a></li>
<li><a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Spring/ViewBehaviourObjectDefinationParser.cs" target="_blank" rel="external">ViewBehaviourObjectDefinationParser</a></li>
</ul>
<p>This is our “how”, where the actual work gets done. In these object definition parsers we process the xml and drive an <code>ObjectDefinitionBuilder</code> provided by Spring.</p>
<p>If we consider a simple example of this implementation in <code>ViewBehaviourObjectDefinationParser</code>. First we override <code>GetObjectTypeName</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">string</span> <span class="title">GetObjectTypeName</span>(XmlElement element) {</div><div class="line">    <span class="keyword">return</span> element.GetAttribute(<span class="string">"type"</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>When our element <code>view</code> is encountered and <code>ViewBehaviourObjectDefinationParser</code> is resolved from its registration for this element, Spring asks for a string expression of the type for the object that will be created for this element. We simply read this from the elements <code>@type</code> attribute, exactly as Spring normally would.</p>
<p>Next we need to deal with any constructor injection, and it turns out that because we’re processing elements in our own namespace, elements from Springs namespace still work as expected, allowing us to mix and match to some extent.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">behaviour</span> <span class="attribute">responds-to</span>=<span class="value">"parse-request"</span> </span></div><div class="line">    <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.ParseRequestBehaviour, Inversion.Web"</span></div><div class="line">&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">spring:constructor-arg</span> </span></div><div class="line">        <span class="attribute">name</span>=<span class="value">"appDirectory"</span> </div><div class="line">        <span class="attribute">value</span>=<span class="value">"Inversion.Web.Harness.Site"</span> </div><div class="line">    /&gt;</div><div class="line"><span class="tag">&lt;/<span class="title">behaviour</span>&gt;</span></div></pre></td></tr></table></figure>

<p>Note the <code>spring:constructor-arg</code> within the <code>behaviour</code> element.</p>
<p>So we’re in the rather comfy position of retaining Springs base functionality in this area and merely adding syntactic sugar where it suits us.</p>
<p>Spring calls <code>DoParse</code> on our definition parser, and passes it the associated element.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoParse</span>(XmlElement xml, ObjectDefinitionBuilder builder) {</div><div class="line">    <span class="comment">// all behaviours with config being parsed have @respondsTo</span></div><div class="line">    <span class="keyword">string</span> respondsTo = xml.GetAttribute(<span class="string">"responds-to"</span>);</div><div class="line">    builder.AddConstructorArg(respondsTo);</div><div class="line"></div><div class="line">    <span class="comment">// all view behaviours have @content-type</span></div><div class="line">    <span class="keyword">string</span> contentType = xml.GetAttribute(<span class="string">"content-type"</span>);</div><div class="line">    builder.AddConstructorArg(contentType);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>In this example we are extracting the <code>@responds-to</code> and <code>@content-type</code> attributes and adding them to the object definition builder as constructor arguments.</p>
<h3 id="Reading_the_behaviour_configuration_from_XML">Reading the behaviour configuration from XML</h3>
<p>Okay, so if we take stock, we’re by this point able to provide our own expressions in XML of object definitions. This doesn’t speak to our provision of a set of tuples as configuration for a behaviour.</p>
<p><a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Spring/BehaviourObjectDefinationParser.cs" target="_blank" rel="external">BehaviourObjectDefinationParser</a> is a little more gnarly than our definition parser for view behaviours, but it’s <code>DoParse</code> isn’t too wild. We iterate over the xml nodes and construct a hashset of tuples from them, and once we have them we call <code>builder.AddConstructorArg(elements)</code> to tell Spring that we’re using them as the next constructor argument.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// we're going to read the config into tuples</span></div><div class="line"><span class="comment">// of frame, slot, name, value</span></div><div class="line"><span class="keyword">foreach</span> (XmlElement frameElement <span class="keyword">in</span> frames) {</div><div class="line">    <span class="keyword">string</span> frame = frameElement.Name;</div><div class="line"></div><div class="line">    <span class="comment">// process any frame attributes as &lt;frame slot="name" /&gt;</span></div><div class="line">    <span class="keyword">foreach</span> (XmlAttribute pair <span class="keyword">in</span> frameElement.Attributes) {</div><div class="line">        <span class="keyword">string</span> slot = pair.Name;</div><div class="line">        <span class="keyword">string</span> name = pair.Value;</div><div class="line">        Configuration.Element element = <span class="keyword">new</span> Configuration.Element(ordinal, frame, slot, name, String.Empty);</div><div class="line">        elements.Add(element);</div><div class="line">        ordinal++;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (XmlElement slotElement <span class="keyword">in</span> frameElement.ChildNodes) {</div><div class="line">        <span class="keyword">string</span> slot = slotElement.Name;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> start = elements.Count;</div><div class="line">        <span class="comment">// read children of slot as &lt;name&gt;value&lt;/name&gt;</span></div><div class="line">        <span class="keyword">foreach</span> (XmlElement pair <span class="keyword">in</span> slotElement.ChildNodes) {</div><div class="line">            <span class="keyword">string</span> name = pair.Name;</div><div class="line">            <span class="keyword">string</span> <span class="keyword">value</span> = pair.InnerText;</div><div class="line">            Configuration.Element element = <span class="keyword">new</span> Configuration.Element(ordinal, frame, slot, name, <span class="keyword">value</span>);</div><div class="line">            elements.Add(element);</div><div class="line">            ordinal++;</div><div class="line">        }</div><div class="line">        <span class="comment">// read attributes of slot as name="value"</span></div><div class="line">        <span class="keyword">foreach</span> (XmlAttribute pair <span class="keyword">in</span> slotElement.Attributes) {</div><div class="line">            <span class="keyword">string</span> name = pair.Name;</div><div class="line">            <span class="keyword">string</span> <span class="keyword">value</span> = pair.Value;</div><div class="line">            Configuration.Element element = <span class="keyword">new</span> Configuration.Element(ordinal, frame, slot, name, <span class="keyword">value</span>);</div><div class="line">            elements.Add(element);</div><div class="line">            ordinal++;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (elements.Count == start) { <span class="comment">// the slot had no name/value pairs</span></div><div class="line">            Configuration.Element element = <span class="keyword">new</span> Configuration.Element(ordinal, frame, slot, String.Empty, String.Empty);</div><div class="line">            elements.Add(element);</div><div class="line">            ordinal++;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line">builder.AddConstructorArg(elements);</div></pre></td></tr></table></figure>

<p>Nothing clever happening here at all, left rather verbose and explicit to assist with debugging.</p>
<p>So we have our behaviours configurations nicely integrated with Spring, and with reasonable opportunity for extension.</p>
<p>Lastly from our <code>behaviour.xsd</code> schema we can default attribute values for elements, as we do for <code>message-sequence@type</code>:-</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">xsd:element</span> <span class="attribute">name</span>=<span class="value">"message-sequence"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">xsd:complexType</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">xsd:complexContent</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">xsd:extension</span> <span class="attribute">base</span>=<span class="value">"configured-behaviour-type"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="title">xsd:attribute</span> <span class="attribute">name</span>=<span class="value">"type"</span> <span class="attribute">type</span>=<span class="value">"xsd:string"</span> <span class="attribute">use</span>=<span class="value">"optional"</span> <span class="attribute">default</span>=<span class="value">"Inversion.Process.Behaviour.ParameterisedSequenceBehaviour, Inversion.Process"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="title">xsd:extension</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">xsd:complexContent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">xsd:complexType</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">xsd:element</span>&gt;</span></div></pre></td></tr></table></figure>

<p>This allows us to write <code>message-sequence</code> with it’s <code>@type</code> value supplied by the schema.</p>
<p>The end result of these extenstions is the ability to express cleanly in XML the equivalent of our in code configuration of behaviours, as can be seen in <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Web.Harness.Site/behaviours.config" target="_blank" rel="external">behaviour.config</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">spring:list</span>  <span class="attribute">element-type</span>=<span class="value">"Inversion.Process.Behaviour.IProcessBehaviour, Inversion.Process"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="title">message-sequence</span> <span class="attribute">responds-to</span>=<span class="value">"process-request"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">fire</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">bootstrap</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">parse-request</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">work</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">view-state</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">process-views</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">render</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">fire</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">message-sequence</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="title">behaviour</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"bootstrap"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.BootstrapBehaviour, Inversion.Web"</span></div><div class="line">    &gt;</div><div class="line">        <span class="tag">&lt;<span class="title">context</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">set</span> </span></div><div class="line">                <span class="attribute">area</span>=<span class="value">"default"</span> </div><div class="line">                <span class="attribute">concern</span>=<span class="value">"default"</span> </div><div class="line">                <span class="attribute">action</span>=<span class="value">"default"</span> </div><div class="line">                <span class="attribute">appPath</span>=<span class="value">"/web.harness"</span> </div><div class="line">            /&gt;</div><div class="line">        <span class="tag">&lt;/<span class="title">context</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">behaviour</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="title">behaviour</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"parse-request"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.ParseRequestBehaviour, Inversion.Web"</span></div><div class="line">    &gt;</div><div class="line">        <span class="tag">&lt;<span class="title">spring:constructor-arg</span> <span class="attribute">name</span>=<span class="value">"appDirectory"</span> <span class="attribute">value</span>=<span class="value">"Inversion.Web.Harness.Site"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">behaviour</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="title">behaviour</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"view-state"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.ViewStateBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="title">behaviour</span>  </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"process-views"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.ProcessViewsBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="title">behaviour</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"render"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.RenderBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- VIEWS --&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="title">view</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"rzr::view"</span> </div><div class="line">        <span class="attribute">content-type</span>=<span class="value">"text/html"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.View.RazorViewBehaviour, Inversion.Web"</span></div><div class="line">    /&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">view</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"xml::view"</span> </div><div class="line">        <span class="attribute">content-type</span>=<span class="value">"text/xml"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.View.XmlViewBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">view</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"json::view"</span> </div><div class="line">        <span class="attribute">content-type</span>=<span class="value">"text/json"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.View.JsonViewBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">view</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"xslt::view"</span> </div><div class="line">        <span class="attribute">content-type</span>=<span class="value">"text/xml"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.View.XsltViewBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">view</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"xsl::view"</span> </div><div class="line">        <span class="attribute">content-type</span>=<span class="value">"text/html"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.View.XsltViewBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">view</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"st::view"</span> </div><div class="line">        <span class="attribute">content-type</span>=<span class="value">"text/html"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.StringTemplate.Behaviour.View.StringTemplateViewBehaviour, Inversion.StringTemplate"</span> </div><div class="line">    /&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- app --&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="title">message-trace</span> <span class="attribute">responds-to</span>=<span class="value">"*"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">event</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">match</span> <span class="attribute">trace</span>=<span class="value">"true"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">event</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">message-trace</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="title">message-sequence</span> <span class="attribute">responds-to</span>=<span class="value">"work"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">context</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">match-any</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="title">action</span>&gt;</span>test1<span class="tag">&lt;/<span class="title">action</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="title">action</span>&gt;</span>test2<span class="tag">&lt;/<span class="title">action</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="title">match-any</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">context</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">fire</span>&gt;</span>                  </div><div class="line">            <span class="tag">&lt;<span class="title">work-message-one</span> <span class="attribute">trace</span>=<span class="value">"true"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">work-message-two</span> <span class="attribute">trace</span>=<span class="value">"true"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">fire</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">message-sequence</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="title">spring:list</span>&gt;</span></div></pre></td></tr></table></figure>

<p>Which can be compared with a <a href="https://github.com/guy-murphy/inversion-dev/blob/55e8e6b302016c4c805a376a29abb4cccb3eb599/Inversion.Web.Harness.Site/behaviours.config" target="_blank" rel="external">previous version</a>. The difference is stark.</p>
<p>We can also see here both the beginning of our own domain specific language in the configuration of our behaviours, but more importantly the ability for other developers to extend this with their own semantics. </p>
<p>Consider the following definition of a behaviour:-</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">some-behaviour</span> <span class="attribute">responds-to</span>=<span class="value">"something"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">resource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">exist</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">path</span>&gt;</span>Resources/Results/result-1-1.xml<span class="tag">&lt;/<span class="title">path</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">exists</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">resource</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">some-behaviour</span>&gt;</span></div></pre></td></tr></table></figure>

<p>I just made that up, but hopefully it begins to become clear how that will be read as a set of tuples for the behaviours configuration that I can act on. You can make your own stuff up, which is what open for extension means. The ability for you to make stuff up, that I didn’t foresee and without you having to ask me to modify my stuff.</p>
<p>There’s a strong smell of Prolog around here now. If you’re familiar with Prolog, think of assertions upon which predicates act.</p>
<h3 id="A_little_caveat_on_reading_XML_as_a_set_of_tuples">A little caveat on reading XML as a set of tuples</h3>
<p>In a relation of tuples you can’t have a duplicate tuple, so tuples that are repeated are collapsed down to the one tuple. The consequence of this is you can’t do…</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">{<span class="string">"fire"</span>, <span class="string">"bootstrap"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"parse-request"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"work"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"work"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"work"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"view-state"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"process-views"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"render"</span>}</div></pre></td></tr></table></figure>

<p>As you’ll end up with just the one <code>{&quot;fire&quot;, &quot;work&quot;}</code> tuple. The elements as implemented express an ordinal so it is possible to change this to allow duplicate tuples but I want to digest what the implications of that might be first, and to wait and see what if any pain it actually may cause in practice, before fixing something that may not be broke.</p>
<p>You could as stands move past this problem by moving to something like <code>{&quot;fire-repeat&quot;, &quot;work&quot;, &quot;3&quot;}</code>.</p>
<p>We have enough here to feel confident in adapting to our needs in this area over time. We’re not walled in if we experience pain in this.</p>
<h2 id="Reviewing_our_goals">Reviewing our goals</h2>
<p><em>TL;DR It went rather well, or I’d not be writing about it.</em></p>
<p>I listed a bunch of goal, principles or aspirations that are important to Inversion. I find it important after a non-trivial piece of work to consciously run down a mental check-list and ensure that I’m not negatively impacting any of those goals without compelling reason. The purpose of such a review is not to seek perfection but to ensure simple forward progress in each area, even if it’s only inching forward. Incremental improvement, <a href="http://en.wikipedia.org/wiki/Kaizen" target="_blank" rel="external">kaizen</a> and all that.</p>
<p>This is just my sharing informal observations after a piece of work. Normally I would use my internal dialogue.</p>
<ul>
<li><p><em>Black-box components</em></p>
<p>  Inversion has a strong opinion on behaviours as black boxes being as opaque as possible. This is why we don’t inject implementation components into behaviours, and encourage behaviours to use service location to locate the component they need for their implementation. The reasons for this are outlined in other pieces I’ve written and is something I’ll write about more in the future. The short version is a concern with leaking implementation details, and imposing externally visible <em>has-a</em> relationships upon components where <em>uses-a</em> would be more appropriate. A behaviour may use configuration to form the basis of component location, but that is a detail of implementation not common interface.</p>
<p>  This concern speaks to behaviours only. How data-access components obtained from an IoC container are instantiated and injected for example is a separate and distinct architectural concern. Behaviours are participating in a component model around which there are specific expectations. Other services aren’t.</p>
<p>  Anything that distracts from a behaviours condition and action is a potentially undesirable overhead, especially if its leaking details across the interface. Moving from multiple data-structures to the one whose interface does not express intent, focuses on being a simple, generalised, immutable structure of string values that can serve multiple purposes… While not a radical improvement in terms of behaviours as black-boxes, it’s a definite improvement. We’re leaking less. Configuration becomes a standardised input at instantiation.</p>
<p>  Intent is expressed where desirable through the data-structures actual data, not it’s interface. This is what is meant by moving to a more generalised data-structure.</p>
</li>
<li><p><em>Substitution, “pluggability”</em></p>
<p>  Related to the interest in black-boxes, this isn’t a <a href="http://en.wikipedia.org/wiki/Liskov_substitution_principle" target="_blank" rel="external">Liskov</a> concern. This is a very real and practical concern with being able to swap out components with alternate implementations. Change the type specified by that attribute and nothing else needs to change kind of swapping out. Behaviours as extensible <a href="http://www.martinfowler.com/eaaCatalog/plugin.html" target="_blank" rel="external">plugins</a>.</p>
<p>  Again no tectonic shift here, as with the previous point, the focus of many interfaces into one common interface shared by many behaviours provides substantially less friction to behaviours as plugins.</p>
</li>
<li><p><em>Configuration as resource distinct from application</em></p>
<p>  Expressing configuration is more standardised, expressive, and more elegant especially when using XML notation thanks to the Spring.NET extensions. The change is impactful enough that we’re now starting as a natural matter of course to express our own semantics through configuration.</p>
<p>  So while configuration has not been made any more distinct as a resource, the quality of it’s use as a distinct resource has been much improved, and I have hope that it will over time become a pleasure to use and a welcome tool for the developer rather than an onerous liability.</p>
</li>
<li><p><em>Favouring composition over inheritance for application behaviour</em></p>
<p>  With the original implementation there was a lot of pressure to inherit from various classes in order to inherit some of their configuration features. This caused a lot of strain on inheritance.</p>
<p>  With the move to a common data-structure for configuration we took away pressure from inheriting to gain varying configuration properties.</p>
<p>  With the move to predicates as methods extending <code>IConfiguredBehaviour</code> we took pressure away from having to inherit from a particular class in order to pick up it’s condition predicates.</p>
<p>  What we didn’t escape was the need to actually use these predicates in a condition, therefore making it desirable to inherit from some classes in order to obtain the checks they perform in their condition.</p>
<p>  So this is really a 2 out of 3 in this regard. We have relieved pressure from inheritance in quite a marked way, but there remains an impediment that will require more thought and work.</p>
</li>
</ul>
<ul>
<li><p><em>Small footprint micro-framework</em></p>
<p>  This was one of the primary reasons for the piece of work and one of the more substantial wins as it’s reduced down the footprint of the behaviour interface and provides a strategy for accommodating future change without modification. Behaviour configuration is in a markedly better state than it was. Far more compact in design.</p>
</li>
<li><p>Single responsibility</p>
<p>  Providing configuration features was starting to distract from a behaviours responsibility to provide a condition/action pair, with an emphasis on the action. Most of the responsibility for expressing configuration and working with it has been removed from the behaviour which for the most part now merely has a configuration that was provisioned by a base class and is acted on by extension methods. So our focus on the actual responsibility of behaviours has been tightened.</p>
</li>
<li><p><em>Extensibility, DIY</em></p>
<p>  This again was one of the primary reasons for performing this piece of work. There was a desire in the face of feature requests concerning configuration and predicates to be able to reasonably reply “do it yourself”.</p>
<p>  On the one hand there’s a big gain. <a href="http://en.wikipedia.org/wiki/Resource_Description_Framework" target="_blank" rel="external">RDF</a> is able to describe the world with triples, and it turns out <a href="http://www.w3.org/TR/n-quads/" target="_blank" rel="external">N-Quads</a> is a thing. The point is, in terms of data expression you can drive a Mongolian Horde though an ordered set of four element tuples. It makes it very easy for other developers to extend with their own configuration expressions.</p>
<p>  As mentioned previously adding new predicates as extension methods is now also smooth.</p>
<p>  We’re still stuck on having to actually use these predicates as mentioned.</p>
<p>  The issue isn’t implementing the lookup of predicate strategies, it can be as simple as a dictionary of lambdas, the cause for concern is where to define this, and where to inject it. Which object should be responsible for maintaining this lookup? It probably fits well enough on the context, but it would require the context to hold implementation details of behaviours, and I want to think about that some.</p>
</li>
<li><p><em>Inversion of Control</em></p>
<p>  I’m not sure I would go so far as to say IoC has been significantly enhanced here. Behaviour implementations have certainly relinquished much of their control over their configuration. Perhaps a nudge in the right direction for IoC is that it is now easier for developers to drive both their condition and action from configuration, so we have perhaps afforded more opportunity for IoC.</p>
</li>
<li><p><em>Testability</em></p>
<p>  No big wins in functional terms here, the more concise and expressive configuration is simply easier and more pleasant to use, so unit tests for example that would tend to want to configure a wide variety of cases and so are big users of configuration certainly benefit.</p>
<p>  While I was rummaging around the framework touching lots of different bits I also took a slight detour to implement <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Web/MockWebContext.cs" target="_blank" rel="external">MockWebContext</a> along with <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Web/MockWebRequest.cs" target="_blank" rel="external">MockWebRequest</a> and <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Web/MockWebResponse.cs" target="_blank" rel="external">MockWebResponse</a> as I had a need to lay down some half-decent tests. Nothing exciting, you can see their use in <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Web.Tests/Behaviour/ViewPipelineTests.cs" target="_blank" rel="external">ViewPipelineTests</a>. </p>
<p>  So overall this patch of work puts Inversion in quite a strong position for testing with it possible to test contexts running a full application life-cycle for a request, or any behaviour or group of behaviours in concert as needed. Very few behaviours have a dependency on <code>IWebContext</code>, in this case only those parsing the request and writing the response, so testing even a view pipeline is straight-forward.</p>
</li>
<li><p><em>Portability</em></p>
<p>  No big impact here except there’s less to port. The use of LINQ statements is an implementation detail, and there are easy equivalent implementations available on all common platforms. There’s nothing exotic being done here.</p>
</li>
<li><p><em>Conventions for state</em></p>
<p>  Inversion attempts to place mutable state in known places, and to keep state elsewhere as immutable and simple as possible. We’ve consolidated down our configuration to a single immutable structure, so a small nudge in the right direction.</p>
</li>
<li><p><em>Speed</em></p>
<p>  Performance tests are showing the same figures. There wasn’t expected to be any change here, a move to backing configuration with arrays in the future may squeeze out some performance gains.</p>
</li>
<li><p><em>Other observations</em></p>
<p>  I’m starting to become mildly concerned over the use of LINQ methods used in a fluent style in implementation code. I have become aware of how often when debugging I am changing a linq statement into a simpler form in order to step through it and see what’s happening. I take this as a very loud warning sign. Often my use of linq is pure vanity as it has go-faster stripes. I think I’m going to start avoiding fluent chained statements, and expose the intermediary steps as local variables in order to make debugging easier… Difficult to force myself perhaps, as linq is bloody expressive.</p>
</li>
</ul>
<h2 id="Future_work">Future work</h2>
<p><em>TL;DR My flaky ideas.</em></p>
<p>There’s a couple of progressions I can see to this work, but first I want to let the existing work bed in before jumping the gun.</p>
<h3 id="Backing_the_configuration_elements_with_an_array">Backing the configuration elements with an array</h3>
<p>At the moment the <code>Configuration</code> is backed by <code>ImmutableHashSet&lt;IConfiguratonElement&gt;</code>. This is reasonably efficient, and is easy to work with. It could however be moved to being backed by an array:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">string</span>[][] config = <span class="keyword">new</span>[] {</div><div class="line">     <span class="keyword">new</span>[] {<span class="string">"frame1"</span>, <span class="string">"slot1"</span>, <span class="string">"name1"</span>, <span class="string">"value1"</span>},</div><div class="line">     <span class="keyword">new</span>[] {<span class="string">"frame2"</span>, <span class="string">"slot2"</span>, <span class="string">"name2"</span>, <span class="string">"value2"</span>}</div><div class="line">};</div></pre></td></tr></table></figure>

<p>Which would probably be more efficient.</p>
<p>I did it this way as it was easier to reason about and debug, and those are still valid reasons at the moment. Once it’s become part of the furniture, then I can think about trying this out.</p>
<h3 id="Expressing_tuples_relative_to_the_preceding_tuple">Expressing tuples relative to the preceding tuple</h3>
<p>There’s an improvement I can vaguely see… because the tuples are ordered, we can consider a new tuple as an expression relative to the previous tuple.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="operator">a</span>, b, c, d)</div><div class="line">((-<span class="number">2</span>), e, f) <span class="built_in">relative</span> <span class="built_in">to</span> <span class="operator">the</span> previous tuple =&gt; (<span class="operator">a</span>, b, e, f)</div><div class="line">((<span class="number">0</span>), g, h) becomes =&gt; (<span class="operator">a</span>, b, e, f, g, h)</div><div class="line">((-<span class="number">4</span>), x) becomes =&gt; (<span class="operator">a</span>, b, x)</div></pre></td></tr></table></figure>

<p>Relations of tuples include a lot of repetition in many cases. Using an expression of an offset from the end would allow us to express an uncapped arity of tuples with the limit being on how many new elements of a tuple we could expand by at a time. They could get effectively as large as you like… Think of scanning the list of tuple definitions using a stack as a point of context, you pop the specified amount of elements, and then push the rest on, the result is your current tuple. You could put this stack based iteration behind <code>IEnumerable&lt;IConfigurationElement&gt;</code> and anybody using it say via LINQ would be none the wiser.</p>
<p>My thinking on this is still fuzzy, and I feel it may be more than is required, possibly turning something quite straight-forward into something quite convoluted. Once I’ve thought through it a bit more, it may just be an obviously bad idea in practice. </p>
<p>Also sometimes a little constraint is an appropriate restraint. Time will tell.</p>
<h3 id="The_lookup_of_condition_predicates">The lookup of condition predicates</h3>
<p>As discussed, at the moment predicates to act on configuration are provided as extension methods which need to be used in conditions. The <code>frame</code> of a tuple could be used as a key to lookup the predicate to apply to it by a variety of mechanisms.</p>
<p>This would add extensibility but may be one indirection too far.</p>
<h2 id="In_parting">In parting</h2>
<p>I always feel a bit odd after I write something like this up. I’m not sure what use or interest this is beyond a small group of involved people, but I find I’m getting a lot of value out of explaining a thing in a public context. It’s certainly encouraging my thinking toward more rigour, so it’s a worthwhile activity for that reason alone.</p>
<p>My attempt at writing this up isn’t to show any arrival upon a perfect landing spot, but instead relate in some way software development and architectural concern as an incremental process of improvement moving toward a goal.</p>

      
    </div>
    <footer>
      
        
        
      
      
  
  <div class="tags">
    <a href="/tags/inversion/">inversion</a>, <a href="/tags/patterns/">patterns</a>
  </div>

      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-11-27T03:43:18.000Z"><a href="/2014/11/27/I-come-not-to-bury-IoC-but-to-praise-it/">Nov 27 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/27/I-come-not-to-bury-IoC-but-to-praise-it/">I come not to bury IoC but to praise it.</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Or, <em>All elephants are grey, that’s grey, therefore that’s an elephant.</em></p>
<p>I have used Spring.NET since 2006 when I first used it as the backbone of an MVC framework and CMS on the .NET platform, and I have used it aggressively since and to this day, inducting several development teams into its use over that time.</p>
<p>I felt compelled to give my credentials there as a good card carrying developer, hip to current trends, who finds it almost unthinkable to write a non-trivial application without an IoC container. I feel compelled because this piece may be unfashionable and I’m kind of dimly aware could make me unpopular in the current development community in which I find myself. Nobody likes to voice an unpopular view. We fear others will think us stupid.</p>
<p>It’s important that any reader appreciate that I am writing as .NET developer, lead and architect working in London. There may well be wider applicability to my views, but I can’t know that, as my observations are based on… well, what I get to observe. Things may be similar where you are, but they may not.</p>
<h2 id="A_room_full_of_smart_people_wearing_bell-bottoms,_because…">A room full of smart people wearing bell-bottoms, because…</h2>
<p>I have found myself on more than one occasions saying to my developers, <em>“commercial software development is first and foremost a social activity before it is anything else”</em>. I’d been saying that (possibly while stroking my beard) for some time before I actually stopped to think about it, because I felt quite a level of conviction, before I really understood what I meant. </p>
<p>It’s not a terribly opaque statement, and it’s really quite obvious the moment you consider it… Before any code gets written, before any infrastructure is laid down, a bunch of people are going to make a whole bunch of decisions.  Throughout the development of an application, and through it’s support and maintenance a wide assortment of people are going to negotiate between themselves what is right action and what is wrong action. The quality of those decisions will have a significant impact on the quality of the software and ultimately equate to pound signs either written in black or red.</p>
<p>There are libraries filled with books written on the subject of people and decision making by writers far more studied in the subject than myself. I want to focus for the moment on one specific aspect of groups of developers and architects making technical decisions together. The acceptance without scrutiny of self evident virtue received as common wisdom from a peer group. Known by the more plain speaking as <strong>Fashion</strong>.</p>
<p>There’s a couple of angles I could take at this and I may explore other areas later, but for now I want to drill into Inversion of Control and Dependency Injection a little, and the manner of it’s pervasive use in the .NET development community currently.</p>
<p>I’ll admit that’s a lot of packaging before getting to the content.</p>
<h2 id="Inversion_of_Control_(IoC)">Inversion of Control (IoC)</h2>
<p>So what is IoC? It’s almost impossible to answer that question without first asking <em>“when?”</em>, because the expected answer to that question in interview today is very different than those who coined the term would give.</p>
<blockquote>
<p><a href="http://martinfowler.com/articles/injection.html" target="_blank" rel="external">Martin Fowler</a> When these containers talk about how they are so useful because they implement “Inversion of Control” I end up very puzzled. Inversion of control is a common characteristic of frameworks, so saying that these lightweight containers are special because they use inversion of control is like saying my car is special because it has wheels.</p>
</blockquote>
<p>I am reminded of the fact that if more people read Fielding’s <a href="http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven" target="_blank" rel="external">own comments on the application of REST</a>, there would be a lot fewer articles and books on REST, and far fewer applications calling themselves RESTful. Concepts percolate through the development community and in the same way the truth of an event in some distant foreign country will go through many changes before it reaches your tabloid front-page, so do concepts in software development before they end up in the blog post you’re reading.</p>
<p>If we’re not lazy however, we can go back to their root and origin.</p>
<blockquote>
<p><a href="http://www.laputan.org/drc/drc.html" target="_blank" rel="external">Ralph Johnson and Brian Foote</a> One important characteristic of a framework is that the methods defined by the user to tailor the framework will often be called from within the framework itself, rather than from the user’s application code. The framework often plays the role of the main program in coordinating and sequencing application activity. This <strong>inversion of control</strong> gives frameworks the power to serve as extensible skeletons. The methods supplied by the user tailor the generic algorithms defined in the framework for a particular application.</p>
</blockquote>
<p>That quote, which is referenced by Mr. Fowler’s writing on IoC and was written in 1988. If I can persuade you to read just one paper, please make it this one. </p>
<h3 id="What_is_IoC_trying_to_achieve?">What is IoC trying to achieve?</h3>
<p>Before we look at the ways in which IoC is in someway a special case, it is useful perhaps to consider what it shares in common with a broader approach.</p>
<p>IoC participates in a movement to develop techniques for more reusable code, along with a bunch of other principles to this end. One of the success criteria then for our employment of IoC then is the degree to which we attain code reuse.</p>
<p>The environment in which IoC grew-up code reuse was seen not just as a means of increasing productivity, it was seen as essential if systems were to be allowed to grow and evolve over time, without collapsing under their own weight of complexity. There’s a lot of talk of class libraries evolving into frameworks, and frameworks evolving from <a href="http://en.wikipedia.org/wiki/White_box_(software_engineering%29" target="_blank" rel="external">white box</a> systems to <a href="http://en.wikipedia.org/wiki/Black_box" target="_blank" rel="external">black box</a> as our understanding of a systems abstraction improve with experience. There’s importance given in the early talk of and around IoC to the human factor at play within development. Systems should it was thought change as our understanding as a group of people engaged with a problem domain changes. The system should evolve in tandem with our understanding of it.</p>
<p>This approach to software development as an evolving system requires a focus on decoupling of implementation from use, an aggressive focus on discrete interfaces, and an almost obsessive regard for component substitution (plug-ability).</p>
<p>This common goal is what IoC is meant to further, to yield systems resilient to change.</p>
<h3 id="So_what_is_IoC?">So what is IoC?</h3>
<p>It’s a lot of different things.</p>
<blockquote>
<p><a href="http://martinfowler.com/bliki/InversionOfControl.html" target="_blank" rel="external">Martin Fowler</a> There is some confusion these days over the meaning of inversion of control due to the rise of IoC containers; some people confuse the general principle here with the specific styles of inversion of control (such as dependency injection) that these containers use. The name is somewhat confusing (and ironic) since IoC containers are generally regarded as a competitor to EJB, yet EJB uses inversion of control just as much (if not more).</p>
</blockquote>
<p>Whoah. Something more IoC than an IoC Container?</p>
<p>One of the characteristics of the practice of religious faith, is that it often doesn’t stand up to scrutiny with its founding texts and prophets.</p>
<blockquote>
<p><a href="http://martinfowler.com/bliki/InversionOfControl.html" target="_blank" rel="external">Martin Fowler</a> Another way to do this is to have the framework define events and have the client code subscribe to these events. .NET is a good example of a platform that has language features to allow people to declare events on widgets. You can then bind a method to the event by using a delegate.</p>
</blockquote>
<p>You’ve been doing IoC for a long time, in a lot of different ways, long before you ever found <a href="http://www.ninject.org/" target="_blank" rel="external">Ninject</a>.</p>
<p>Inversion of Control is any pattern that inverts the traditional procedural flow of control. That’s it. The purpose of which is to reduce coupling between components to make them easier to swap out, and to promote flexible application evolution that is able to cope with new abstraction built from it.</p>
<h2 id="Just_because_your_mouse_is_grey_doesn’t_mean_it’s_an_elephant">Just because your mouse is grey doesn’t mean it’s an elephant</h2>
<p>Consider the following wee piece of code…</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">context.FireWith(<span class="string">"user-store::delete-user"</span>, <span class="string">"user-id"</span>);</div></pre></td></tr></table></figure>

<p>Which is a straight-up imperative call. We have the expectation that a named component will delete the user specified. It’s a message-based call, and there are valid aspects of decoupling taking place here, but it’s weak in terms of IoC as it’s a traditional forward calling imperative… <em>“Oi! You there, do that.”</em></p>
<p>Almost the same…</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">context.FireWith(<span class="string">"user-unsubscribed"</span>, <span class="string">"user-id"</span>);</div></pre></td></tr></table></figure>

<p>Here we are notifying the system of a significant occurrence. We may have no idea what if anything is going to happen as a side-effect of this. Several things may act upon this, or nothing may act upon this… and we don’t care, because in the second example it’s not our business at this point in the application. This is not an imperative. It’s notifying the broader system of an event… <em>“Excuse me. Anybody there? I don’t want to be a nuisance, but I just did something, and I thought somebody might want to know.”</em>… Henceforth to be known as <em>the English pattern</em>.</p>
<p>In the second example you can have many components responding to the message, each with a discrete narrow focus of purpose. It is open to easy extension by adding new components that will respond to the message, without modifying existing implementation or behaviour. It’s easy to swap out components for ones with different implementations, and the interface is small, discrete and generalised, binding is indirect and at runtime. Feature switching not just at compile time, but at runtime is possible. Lastly at this point in the code, we don’t concern ourself with what happens in the broader system, and require the least possible knowledge about the broader system.</p>
<p>We’re using exactly the same API call here, but this time our expectations are of a reactive response to this event. Here we have inverted the traditional flow of control. Both these calls will use exactly the same mechanic of resolution, but one expresses an inversion of control and one doesn’t.</p>
<p>That’s how narrow the divide can be between flow of control going forward or backwards. The defining factor on either side of that divide is one of intent. By intent I mean an implicit accord on both sides with a common expectation of the meaning of a signal. The balance of the roles and responsibilities in this relationship are for you to decide. It’s about your intent. The mechanism of that signal is important, but not as important as what is being expressed and what is expected. There’s lots of different ways you can use a delegate, many of them will invert control, but simply using a delegate will not get you inversion of control.</p>
<p>It ain’t what you do, it’s the way that you do it, and parroting patterns will not ensure that intent is fulfilled. Understanding intent is key here, as if we understand intent, as long as we’re half-decent developers, our implementations will improve over time and we’ll get there. If we don’t understand the initial intent, our chances of hitting the target are much reduced and start involving luck.</p>
<p>The pioneers laying down these principles did not expect it to be possible for groups of humans to land on the perfect abstraction straight out the gate. They talk about taking flawed initial implementations and iteratively improving our architectural choices. So unless you happen to be some kind of architectural genius that gets their abstractions right first time, a strategy for change becomes a strategy for survival.</p>
<h3 id="Javascript">Javascript</h3>
<p>I’m aware of where Javascript started with Netscape on the server, and I’m aware of where Javascript is today both with <a href="http://nodejs.org/" target="_blank" rel="external">NodeJS</a>. Javascript came of age however in the browser. This meant that Javascript grew up in an environment where the programmer was interacting with a framework (the browser) via an exposed object model.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">onclick</span>=<span class="value">"function(this){/* do something with 'this' */}"</span>&gt;</span></div></pre></td></tr></table></figure>

<p>That’s a good example of inversion of control. We’re registering a callback with an event the framework is going to raise for this element, with the execution of any callbacks managed by the framework. If we think of the alternative, we would need to modify the framework’s core functionality.</p>
<p>This naturally evolves to…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">element.addEventListener(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{ alert(<span class="string">"Hello World!"</span>); });</div></pre></td></tr></table></figure>

<p>Javascript developers weren’t writing complete applications, they were integrating with a framework that forced them to accept IoC as the natural order of things. Modern Javascript frameworks reflect this heritage.</p>
<p>There’s any one of a rampaging horde of Javascript frameworks I could cite for example here, so don’t read too much in my choosing Twitter’s <a href="https://flightjs.github.io/" target="_blank" rel="external">Flight</a> to illustrate the point.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Component definition */</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> Inbox = flight.component(inbox);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">inbox</span><span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">this</span>.doSomething = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{ <span class="comment">/* ... */</span> }</div><div class="line">  <span class="keyword">this</span>.doSomethingElse = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{ <span class="comment">/* ... */</span> }</div><div class="line"></div><div class="line">  <span class="comment">// after initializing the component</span></div><div class="line">  <span class="keyword">this</span>.after(<span class="string">'initialize'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">this</span>.on(<span class="string">'click'</span>, <span class="keyword">this</span>.doSomething);</div><div class="line">    <span class="keyword">this</span>.on(<span class="string">'mouseover'</span>, <span class="keyword">this</span>.doSomethingElse);</div><div class="line">  });</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Attach the component to a DOM node */</span></div><div class="line"></div><div class="line">Inbox.attachTo(<span class="string">'#inbox'</span>);</div></pre></td></tr></table></figure>

<p>It’s not so much that Javascript has such laudable executions of IoC, it’s that the .NET development community has settled on such an anemic consensus on IoC.</p>
<h2 id="And_we’ve_not_mentioned_Dependency_Injection_(DI)_yet">And we’ve not mentioned Dependency Injection (DI) yet</h2>
<p>Because although it’s pervasive, it’s possibly the least interesting aspects of IoC while remaining one of the more convenient.</p>
<blockquote>
<p>In dependency injection, a dependent object or module is coupled to the object it needs at run time. <a href="http://en.wikipedia.org/wiki/Inversion_of_control" target="_blank" rel="external">http://en.wikipedia.org/wiki/Inversion_of_control</a></p>
</blockquote>
<p>Coupled to the object it needs. There is coupling taking place with DI that needs to be managed, and if it’s via constructor injection it’s not necessarily very loose.</p>
<p>I’m looking at an MVC.NET controller with 15 objects injected into it’s constructor. Most of them are repositories. I was intending to count the members of each of those objects, but the first one had 32 public members and I stopped counting there.</p>
<p>How loosely coupled do you think I feel looking at this code? How discrete are the responsibilities being exercised here do you think?</p>
<p>These objects are all injected into the controller by an IoC container. There is a huge surface area being exposed to this component regardless of which particular operation it is performing, with is possessing 27 public members itself.</p>
<p>Just because you are using an IoC container and DI does not mean you are implementing IoC. It just means you’ve found a convenient way to manage instantiation of objects. In my experience this convenience in wiring up components in unthoughtful ways has done considerable harm exhibited by the current swathe of MVC.NET + Entity Framework + Ninject web application all implemented quite cheerfully around SOLID principles.</p>
<blockquote>
<p><a href="http://www.laputan.org/drc/drc.html" target="_blank" rel="external">Ralph Johnson and Brian Foote</a> Sometimes it is hard to split a class into two parts because methods that should go in different classes access the same instance variable. This can happen because the instance variable is being treated as a global variable when it should be passed as a parameter between methods. Changing the methods to explicitly pass the parameter will make it easier to split the class later.</p>
</blockquote>
<p>Your use of the constructor is not inconsequential. I personally aim as much as possible to inject at the constructor only such configuration data as is necessary for that class of component to operate, regardless of implementation. I want as much as possible to be able to swap out implementations without altering their config. Remember that’s what we’re trying to achieve here.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">object</span> <span class="attribute">type</span>=<span class="value">"Conclave.Web.Behaviour.BootstrapBehaviour"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">value</span>=<span class="value">"bootstrap"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"params"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">dictionary</span> <span class="attribute">key-type</span>=<span class="value">"string"</span> <span class="attribute">value-type</span>=<span class="value">"string"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">entry</span> <span class="attribute">key</span>=<span class="value">"area"</span> <span class="attribute">value</span>=<span class="value">"default"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">entry</span> <span class="attribute">key</span>=<span class="value">"concern"</span> <span class="attribute">value</span>=<span class="value">"default"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">entry</span> <span class="attribute">key</span>=<span class="value">"action"</span> <span class="attribute">value</span>=<span class="value">"default"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">entry</span> <span class="attribute">key</span>=<span class="value">"app-path"</span> <span class="attribute">value</span>=<span class="value">"/conclave.cms"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">dictionary</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">constructor-arg</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">object</span>&gt;</span></div></pre></td></tr></table></figure>

<p>We’re configuring behaviour here, regardless of the implementation what we are expressing in this configuration remains the same as our intent is the same. Although we are not obliged contractually we understand the spirit of our intent and try and keep our constructors as honest a part of our interface as possible.</p>
<p>This is DI, but it’s very much light-weight and focuses on configuring the component for use.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">object</span> <span class="attribute">type</span>=<span class="value">"Conclave.Web.Behaviour.View.XslViewBehaviour, Conclave.Web"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">value</span>=<span class="value">"xslt::view"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"contentType"</span> <span class="attribute">value</span>=<span class="value">"text/xml"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">object</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">object</span> <span class="attribute">type</span>=<span class="value">"Conclave.Web.Behaviour.View.XslViewBehaviour, Conclave.Web"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">value</span>=<span class="value">"xsl::view"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">name</span>=<span class="value">"contentType"</span> <span class="attribute">value</span>=<span class="value">"text/html"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">object</span>&gt;</span></div></pre></td></tr></table></figure>

<p>If a component uses rather than has another service for it’s operation it is an implementation detail and is acquired by service location. In this particular framework we care a lot about being able to swap out components, and ensure this intent is met.</p>
<p>In most cases I do not regard it as appropriate to inject something as fat and implementation specific as a repository into a behavioural component. Even though it may be DI, there are too many other principles in the balance that this violates.</p>
<h2 id="The_Dependency_Inversion_Principle_(DIP)">The Dependency Inversion Principle (DIP)</h2>
<p>The “D” in <a href="http://en.wikipedia.org/wiki/SOLID_(object-oriented_design%29" target="_blank" rel="external">SOLID</a> does not stand for Dependency Injection. It stands for the <a href="http://en.wikipedia.org/wiki/Dependency_inversion_principle" target="_blank" rel="external">Dependency inversion principle</a> which is a subtly different thing. And has a focus on implementing interface abstractions and using those interface abstractions.</p>
<blockquote>
<p>The goal of the dependency inversion principle is to decouple application glue code from application logic. Reusing low-level components (application logic) becomes easier and maintainability is increased. This is facilitated by the separation of high-level components and low-level components into separate packages/libraries, where interfaces defining the behavior/services required by the high-level component are owned by, and exist within the high-level component’s package. <strong>The implementation of the high-level component’s interface by the low level component requires that the low-level component package depend upon the high-level component for compilation, thus inverting the conventional dependency relationship</strong>. Various patterns such as Plugin, Service Locator, or Dependency Injection are then employed to facilitate the run-time provisioning of the chosen low-level component implementation to the high-level component. <a href="http://en.wikipedia.org/wiki/Dependency_inversion_principle" target="_blank" rel="external">http://en.wikipedia.org/wiki/Dependency_inversion_principle</a></p>
</blockquote>
<p>In Dependency Inversion, the implementing class is dependent on an interface that is either owned by an intermediary that the high level component is also dependent upon, or the interface is owned by the high level component. </p>
<p>Strictly speaking if the interface isn’t owned by the high level component, the dependency has not been inverted.</p>
<blockquote>
<p>In order to completely achieve dependency inversion, it is important to understand that the abstracted component, or the interface in this case, must be “owned” by the higher-level class. <a href="http://blog.appliedis.com/2013/12/10/lost-in-translation-dependency-inversion-principle-inversion-of-control-dependency-injection-service-locator/" target="_blank" rel="external">http://blog.appliedis.com/2013/12/10/lost-in-translation-dependency-inversion-principle-inversion-of-control-dependency-injection-service-locator/</a></p>
</blockquote>
<p>In Inversion and Conclave you’ll see occasionally a comment along the lines of <code>// we need to own this interface</code>. You’ll also see several BCL components being wrapped such as request and response objects. One of the goals of Inversion is to be easily portable to other platforms, and so it is important to control what interfaces the framework exposes.</p>
<p>We don’t notice this for the most part in everyday development as a lot of our interface abstractions are picked up by the .NET base class library. If I have a low level component implementing <code>IList</code> and a high level component consuming is via <code>IList</code>, we take the stewardship of the interface by the BCL as good-enough, and quite reasonably don’t get too pedantic over the fact this isn’t DIP as the high level component doesn’t own the interface. A stable and neutral third-party is often anointed by the high level component. That example is a little contrived for simplicity as lists are not the kind of components we would normally engage this level of concern over, but more valid examples are to be found in the <code>System.Data</code> namespace.</p>
<p>This principle can quickly get quite fiddly in practice so often its pragmatically summarised as <em>“don’t use concretes”</em>, which gives 80% of its goodness, but not all.</p>
<p>Consider the use of the <code>Newtonsoft.Json</code> package. It’s such a brilliant package that it’s used extensively. When a high level component couples with these interfaces it becomes dependent on them in the traditional way. You don’t control those interfaces, Newtonsoft do. In most cases use of such foreign interfaces should be implementation detail that is not exposed to the broader framework.</p>
<p>But there’s a way to dodge most of the issues with DIP entirely, and that is to not use lower level components directly. Instead model the interactions the high level component needs to have with the low level components, treat them as pluggable black-boxes, and only interact with them via an intermediary interface with the framework responsible for resolving that interaction. Messaging is a good example of this, as were the two snippets of code earlier in this piece.</p>
<h2 id="Fashion">Fashion</h2>
<p>When a room full of smart people decide to turn MVC.NET + Entity Framework + Ninject into a the exact opposite of what IoC is trying to achieve, which is to say a rats nest of dependencies, leaking knowledge all over the place, with components coupling like a Roman orgy, we have to ask ourselves how and why?</p>
<p>The best answer I can come up with is fashion.</p>
<p>That’s not to be dismissive or derisory. To be so would only compound the issue. It is to acknowledge that we can see and accept the role of fashion in almost every human endevour, and to suggest that we may need to consider how it impacts our technical choices.</p>
<p>We all have a very real need to feel the support and approval of our peers. It’s not a mild passing influence, it’s wired deep into us as a survival strategy as an animal. As we occupy the more geekish end of the spectrum we tend to seek our approval through demonstrating what we know. Moreover it’s the means by which we earn our living. Saying <em>“I don’t know”</em>, does not necessarily come easy to us.</p>
<p>DIP causes me problems. I disagree in part with some of it’s intent. I don’t want my low level components knowing anything about my higher level components. I have no intention of doing that. That bit of DIP looks like nonsense to me.</p>
<p>When I make that assertion I know a couple of things. The Dependency inversion principle was cooked up by some very smart and well studied people. Given that, there is the distinct possibility that I am missing something. The confusion I feel when considering some aspects of DIP further lends weight to this. If I’m sat in a room of my peers, I risk looking foolish if I express my confusion.</p>
<p>Now imagine I’m a team lead or architect. I’m getting paid to know what I’m doing, and my ability to lead and instruct my team is dependent on their respect for my technical ability. I am making myself vulnerable when I admit to my team that I am experiencing confusion with some methods of application of an architectural principle that the whole .NET community seem to have accepted as self evidently virtuous. It might be easier to just pretend I know, and then to cover my inadequacy coach my team in my version and understanding of DIP as the real thing.</p>
<p>This is how fashionable decisions are made. When the goal becomes to be seen by our peers as “good developers” we are engaged in a social exercise and the technical merits of our choices become secondary.</p>
<p>In every case where I have observed this happening it is either an absence of a team lead, or a failure on the part of the team lead to establish the safety for simple human honesty. Further a failure to acknowledge that despite best intentions we are very fallible, and intellectual honesty needs to be motivated. The technical impact of this is we end up wearing principles like IoC like a fashion accessory with very little honest endevour given to it’s underlying intent.</p>
<p>IoC is great. On the .NET platform it’s a particularly interesting time with so much growth in reactive features on the platform, and the TPL. IoC as it exists currently in commercial web application development on the .NET platform has more to do I would suggest with fashion than anything of substance.</p>

      
    </div>
    <footer>
      
        
        
      
      
  
  <div class="tags">
    <a href="/tags/patterns/">patterns</a>, <a href="/tags/inversion/">inversion</a>
  </div>

      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-11-26T22:25:20.000Z"><a href="/2014/11/26/naiad-a-toy-service-container/">Nov 26 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/26/naiad-a-toy-service-container/">Naiad, a toy service container.</a></h1>
  

    </header>
    <div class="entry">
      
        <p>In the previous piece <a href="http://guy-murphy.github.io/2014/11/24/service-locator-vs-dependency-injection/" target="_blank" rel="external">Service locator vs depdendency injection</a> I had declared, <em>“Service location is, and is provided via an interface on the context that can be implemented inside 10 minutes as a dictionary of lambdas if you had a pressing need.”</em> Which risks being a throw-away comment comprising largely of hot air. So I thought I’d <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Naiad/ServiceContainer.cs" target="_blank" rel="external">knock one up</a>, the guts of which is…</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> ConcurrentDictionary&lt;<span class="keyword">string</span>, <span class="keyword">object</span>&gt; _ctors = <span class="keyword">new</span> ConcurrentDictionary&lt;<span class="keyword">string</span>, <span class="keyword">object</span>&gt;();</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> RegisterService&lt;T&gt;(<span class="keyword">string</span> name, Func&lt;IServiceContainer, T&gt; ctor) {</div><div class="line">    _lock.EnterWriteLock();</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        _ctors[name] = ctor;</div><div class="line">    } <span class="keyword">finally</span> {</div><div class="line">        _lock.ExitWriteLock();</div><div class="line">    }</div><div class="line">}</div><div class="line">        </div><div class="line"><span class="keyword">public</span> T GetService&lt;T&gt;(<span class="keyword">string</span> name) {</div><div class="line">    _lock.EnterReadLock();</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        Func&lt;IServiceContainer, T&gt; ctor = _ctors[name] <span class="keyword">as</span> Func&lt;IServiceContainer, T&gt;;</div><div class="line">        <span class="keyword">return</span> ctor(<span class="keyword">this</span>);</div><div class="line">    } <span class="keyword">finally</span> {</div><div class="line">        _lock.ExitReadLock();</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>It really is just a dictionary of lambdas, and wires up thus…</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">Naiad.ServiceContainer.Instance.RegisterService(<span class="string">"request-behaviours"</span>,</div><div class="line">    container =&gt; {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> List&lt;IProcessBehaviour&gt; {</div><div class="line">            <span class="keyword">new</span> SimpleSequenceBehaviour(<span class="string">"process-request"</span>, container.GetService&lt;List&lt;<span class="keyword">string</span>&gt;&gt;(<span class="string">"life-cycle"</span>)),</div><div class="line">            <span class="keyword">new</span> BootstrapBehaviour(<span class="string">"bootstrap"</span>,</div><div class="line">                <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt; {</div><div class="line">                    {<span class="string">"area"</span>, <span class="string">"default"</span>}, </div><div class="line">                    {<span class="string">"concern"</span>, <span class="string">"default"</span>},</div><div class="line">                    {<span class="string">"action"</span>, <span class="string">"default"</span>},</div><div class="line">                    {<span class="string">"app-path"</span>, <span class="string">"/web.harness"</span>}</div><div class="line">                }</div><div class="line">            ),</div><div class="line">            <span class="keyword">new</span> ParseRequestBehaviour(<span class="string">"parse-request"</span>, <span class="string">"Inversion.Web.Harness.Site"</span>),</div><div class="line">            <span class="keyword">new</span> ViewStateBehaviour(<span class="string">"view-state"</span>),</div><div class="line">            <span class="keyword">new</span> ProcessViewsBehaviour(<span class="string">"process-views"</span>),</div><div class="line">            <span class="keyword">new</span> RenderBehaviour(<span class="string">"render"</span>),</div><div class="line">            <span class="keyword">new</span> RazorViewBehaviour(<span class="string">"rzr::view"</span>),</div><div class="line">            <span class="keyword">new</span> XmlViewBehaviour(<span class="string">"xml::view"</span>, <span class="string">"text/xml"</span>),</div><div class="line">            <span class="keyword">new</span> JsonViewBehaviour(<span class="string">"json::view"</span>, <span class="string">"text/json"</span>),</div><div class="line">            <span class="keyword">new</span> XsltViewBehaviour(<span class="string">"xslt::view"</span>, <span class="string">"text/xml"</span>),</div><div class="line">            <span class="keyword">new</span> XsltViewBehaviour(<span class="string">"xsl::view"</span>, <span class="string">"text/html"</span>),</div><div class="line">            <span class="keyword">new</span> HelloWorldBehaviour(<span class="string">"work"</span>){ </div><div class="line">                MatchingAllParameters = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>,<span class="keyword">string</span>&gt; {</div><div class="line">                    {<span class="string">"action"</span>, <span class="string">"hello"</span>}</div><div class="line">                }</div><div class="line">            }</div><div class="line">        };</div><div class="line">    }</div><div class="line">);</div></pre></td></tr></table></figure>

<p>It isn’t much of any use except as a base-line “simplest possible thing that works” to measure more industrial strength implementations against. Just prodding it with <a href="http://httpd.apache.org/docs/2.2/programs/ab.html" target="_blank" rel="external">apache bench</a> for a ballpark it’s a whisker faster than Spring.NET, which considering the facilities Spring offers leaves me quite impressed with Spring.</p>
<p>There’s a lot of value in returning to the simplest implementation that works as it’s easy to lose track of the cost of components that become an integral part of our applications.</p>
<p>So there’s no misunderstanding, this is a toy. But sometimes all you need is a toy. Inversion started life as a toy, the initial prototype being a predicate/action dictionary, where the predicate acted on an event and the action acted upon a context. In scripting languages knocking prototypes up with the general purpose data structures lying around such as lists and dictionaries is very normal, and we could maybe do with it becoming more of a norm in .NET before we jump off into the deep-end with grand object-models.</p>
<p>As I’m proofing this I can see I need to move the exit from the read lock after looking up the constructor but before executing the constructor… as I say, it’s a toy.</p>

      
    </div>
    <footer>
      
        
        
      
      
  
  <div class="tags">
    <a href="/tags/patterns/">patterns</a>, <a href="/tags/inversion/">inversion</a>
  </div>

      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-11-24T14:11:48.000Z"><a href="/2014/11/24/service-locator-vs-dependency-injection/">Nov 24 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/24/service-locator-vs-dependency-injection/">Service locator vs dependency injection.</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Or, <em>“Who would win the fight between a submarine and a tank?”</em></p>
<p>I much enjoyed reading <a href="http://candordeveloper.com/2013/04/10/dependency-injection-is-over-hyped/" target="_blank" rel="external">a piece on service location vs dependency injection</a> which chimed with some of my own thoughts overs the years.</p>
<p>The article starts with a quote by Martin Fowler, the brilliant man whose brilliant work has given rise to so many cargo-cult practices in the .NET development community. I say “cargo-cult” as I’m implying unreasoned and absolute application of a single principle <em>out of context</em>, to the exclusion of any nuance. It’s worth reading Fowler’s piece as it’s a very balanced take on the subject and not absolutist.</p>
<blockquote>
<p><a href="http://martinfowler.com/articles/injection.html" target="_blank" rel="external">Martin Fowler</a> The choice between Service Locator and Dependency Injection is less important than the principle of separating service configuration from the use of services within an application.</p>
</blockquote>
<p>Architecturally <a href="https://github.com/guy-murphy/inversion-dev" target="_blank" rel="external">Inversion</a> expresses service location, and it avoids any explicit use of dependency injection (DI) while at the same time assuming considerable use of DI by application developers. Given this I thought some brief word on “why” might be useful, while adding my voice of concern about the over use of DI.</p>
<p><a href="https://github.com/guy-murphy/inversion-dev" target="_blank" rel="external">Inversion</a> favours the use of <a href="http://springframework.net/" target="_blank" rel="external">Spring</a> as it’s IoC container, and XML configuration. I’ve long intended to try out <a href="http://autofac.org/" target="_blank" rel="external">autofac</a> as it too apparently has good XML config support. As long as it has good XML config support and performs reasonably well I really don’t care which container I use, because for me the primary requirement is a config notation so I can decouple my config from service use and binary deploys, and so that I can easily manage configuration for an application in different instances.</p>
<p>This core issue seems to get thrown out with the bath-water in near all DI using solutions I have seen in the wild. Why? Because we had a bunch of people write that service locators are an anti-pattern. Like a lot, if it passed by your notice Google <a href="https://www.google.co.uk/#q=service+locator+is+an+anti+pattern" target="_blank" rel="external">“service locator anti pattern”</a>, pick a couple of pieces and read at random for 15 min.</p>
<p>Most of the core arguments regarding service location as an anti-pattern stress the pitfall of runtime rather than compile-time errors caused by failure to fulfill dependency requirements. This is compounded by the dependency graph being buried in implementation code. These are valid concerns, but the counter application as a blanket absolute I feel leads developers into more pitfalls than it avoids. </p>
<p>The emphasis on compile-time errors in this argument leads the developer to favour statically-compiled container configuration, and in most cases the fluent interfaces that are emphasised by modern IoC containers. Without exception in any case I’ve observed this leads to Martin Fowler’s chief concern getting throw out with the bathwater.</p>
<blockquote>
<p>separating service configuration from the use of services within an application</p>
</blockquote>
<p>There are other more insidious issues introduced with the assumption of pervasive DI use.</p>
<h2 id="Abusing_constructors_rather_than_abstracting">Abusing constructors rather than abstracting</h2>
<p>At a very simple level, most examples of DI vs service location assume constructor injection. This is for the valid reason of ensuring the object is instantiated with all it’s dependencies fulfilled, and this is the fig leaf we use to explain this approach. The truth is a little buried anti-pattern in itself.</p>
<p>Dependencies will often vary for different implementations, so what we need to inject varies. The constructor is effectively a big gaping hole in a types interface contract. We can run anything we want through there, and they can vary between implementations. So rather than abstract our dependencies we just throw them through the contructor. This is not a virtue.</p>
<p>In the world of .NET Blog Driven Development combined with MVC.NET and Entity Framework this leads over the course of years almost inexorably to the magic tarball of a dependency graph with all the things touching all the things and the contructor being the means by which we communicate relationships between objects.</p>
<h2 id="Assumptions_about_state">Assumptions about state</h2>
<p>This abuse of constructors as a hole through our interfaces leads us to another problem.</p>
<p>It makes a huge assumption about the state of my type, and will almost compel inexperienced developers to inflict state upon types that don’t need it. We without thought turn a <strong>uses-a</strong> relationship into a <strong>has-a</strong> relationship and ensure we can’t use singletons where appropriate, and steers us away from a swathe of compositional patterns.</p>
<p>This is a big deal for performance in web-applications, and almost ensures while we model relationships between data entities, we don’t model behavioural relationships between objects or pay much of any attention toward how objects use each other.</p>
<h2 id="Writing_assemblies_to_be_consumed_by_others">Writing assemblies to be consumed by others</h2>
<p>The flaming strawman of a horror story that the notion of an anti-pattern is built on is the story of shipping an assembly to a third-party that’s using a service locator, with a dependency that isn’t fulfilled in the config, causing a runtime error that isn’t easy for the consumer to resolve as the dependency is expressed in configuration code.</p>
<p>I call this a strawman as using a service locator in this way for a shipping lib is a complete non-starter. The concern is applicable for any low-level or foundation assembly (as most of us are not shipping libs).</p>
<p><a href="https://github.com/guy-murphy/conclave-public/tree/master/Conclave.Map" target="_blank" rel="external">Conclave.Map</a> and related assemblies have no notion of a service container or locator. It’s part of a data-access layer, and service location is none of its business. Nobody in their right mind is going to suggest injecting a service locator into something that isn’t participating in a component model. It may have a database connection however.</p>
<p>In WinForms a service container is threaded through all the components, because they are participating in a component model. The IO namespaces aren’t because they’re not participating in a component model.</p>
<p>Yes, there are a whole bunch of concerns that should not be addressing service location. There’s a whole bunch of types that shouldn’t have access to the application config at all, that should be agnostic to their environment. Your data access layer probably shouldn’t know anything about HTML or CSS… but that does not make HTML and CSS anti-patterns, it is simply to know that as professionals we make judgment about how we partition concerns within our application while being mindful of principles like <a href="http://en.wikipedia.org/wiki/Law_of_Demeter" target="_blank" rel="external">The Law of Demeter</a> we understand we need to manage carefully the coupling between types.</p>
<p>If however a types responsibility is coordinating between services, and providing application integration with services, then service location is a perfectly reasonable concern, and trying to pretend otherwise because somebody called it an anti-pattern will bend your application out of shape.</p>
<h2 id="Patterns_are_not_universally_applicable_articles_of_faith">Patterns are not universally applicable articles of faith</h2>
<p>Patterns are not <a href="http://en.wikipedia.org/wiki/Catechism" target="_blank" rel="external">catechisms</a>, and they do not direct a moral imperative. Patterns offer solutions to common problems and bring with them their own consequence that will vary between scenarios of application.</p>
<p>Consider message queues. Not unlike service locators they introduce a fire-break of an interface decoupling, taking a lot of of stuff that used to happen <em>here</em> and by whatever means makes it happen over <em>there</em>. Quite where or how often isn’t the business of the application developer looking at one end of it.</p>
<p>Should we wire in a service locator into a low level PDF library that is not participating in a component model? Probably not, for all the same reasons we probably shouldn’t wire in a message queue.</p>
<p>Is this to say then that message queues are an anti-pattern? No, it’s to say you’re a muppet if you wire a domestic power cable from the wall outlet into your wrist-watch to power it. Not because domestic power cables and wall outlets are bad or antithetical, but because if you insist on wiring in power cables in <em>inappropriate</em> ways, you’re going to get an electric shock and will probably render your watch inoperable.</p>
<p>Take 3 Java developers and 3 .NET developers to an imaginary bar in our heads. They’re going to write down an exhaustive list of all the ways in which it is appropriate or inappropriate to use a message queue. Once the Java and .NET devs are done introduce 3 Erlang developers, and there’s going to be a bar fight. This is because an Erlang developer is going to have a completely different architectural take on where it is appropriate to use messaging.</p>
<p>This might seem a bit of a contrived example unless you are a .NET developer using <a href="https://rx.codeplex.com/" target="_blank" rel="external">Rx.NET</a> or <a href="http://msdn.microsoft.com/en-us/library/hh228603.aspx" target="_blank" rel="external">DataFlow</a> in anger. In which case your notions of inter-object communication is probably drifting slowly toward the Erlang chaps and you might surprise your peers by joining the Erlang devs in the ensuing ruck. Further shocking the Java devs when one of their own screams “Scala!” and turns on them… Now throw in 3 Haskel devs and all bets are off. They’re likely to label your whole type-system an anti-pattern… When we look under the table we find a Rails dev rocking themselves whimpering “I just want to build awesome websites”.</p>
<p>As a .NET dev I may favour compile time errors over runtime errors more than say a Python or Ruby developer, but <em>if I am creating a component model that composes at runtime</em>, and I try and eliminate runtime errors as a blanket architectural rule, then I am likely to bend my architecture out of shape.</p>
<h2 id="Using_a_process_context_for_service_location">Using a process context for service location</h2>
<p>So how does <a href="https://github.com/guy-murphy/inversion-dev" target="_blank" rel="external">Inversion</a> and <a href="https://github.com/guy-murphy/conclave-public" target="_blank" rel="external">Conclave</a> approach this? Hopefully with a sense of balance, and an awareness of when the focus is service location and when the focus is dependency injection, with a cut between the two at the appropriate layer for the application to separate its concerns.</p>
<p>Inversion centres around <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Process/ProcessContext.cs" target="_blank" rel="external">process context</a> in much the same way that an ASP.NET application will centre around a <a href="http://msdn.microsoft.com/en-us/library/system.web.httpcontext.aspx" target="_blank" rel="external">HttpContext</a>. This context is used to manage state for a running process and to mediate with actors and resources external to the application. The process context is also responsible for mediating between units of application and business logic, coordinating their activity.</p>
<p>The context <strong>has-a</strong> service container, which is injected in it’s constructor. This interface is held for all process context implementations. If I could specify the constructor on the interface I would (I might take a closer look at the MS design by contract library for .NET).</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="title">ProcessContext</span>(IServiceContainer services) {</div><div class="line">    _serviceContainer = services;</div><div class="line">    <span class="comment">// snip</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">public</span> IServiceContainer Services {</div><div class="line">    <span class="keyword">get</span> { <span class="keyword">return</span> _serviceContainer; }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>Which is completely unremarkable. Slightly more controversial is the interface for <code>IServiceContainer</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> IServiceContainer : IDisposable {</div><div class="line">    T GetService&lt;T&gt;(<span class="keyword">string</span> name);</div><div class="line">    <span class="keyword">bool</span> ContainsService(<span class="keyword">string</span> name);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>This is perhaps slightly controversial as its getting services by name rather than by type. This is because at this level the concern is service location via a generalised component interface. If the service container being used supports DI (and it will), injection is configuration level concern. The component isn’t going to inflict it’s dependency upon the application architecture.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Action</span>(IEvent ev, ProcessContext context) {</div><div class="line">    <span class="keyword">if</span> (ev.HasRequiredParams(<span class="string">"id"</span>)) {</div><div class="line">        <span class="keyword">using</span> (ITopicStore store = context.Services.GetService&lt;ITopicStore&gt;(<span class="string">"store::topic-map"</span>)) {</div><div class="line">            store.Start();</div><div class="line">            Topic topic = store.GetTopic(ev[<span class="string">"id"</span>]);</div><div class="line">            context.ControlState[<span class="string">"topic"</span>] = topic;</div><div class="line">            ev.Object = topic;</div><div class="line">            <span class="keyword">if</span> (topic == Topic.Blank) {</div><div class="line">                context.Errors.CreateMessage(...);</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>So here we have the action of an <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Process/IProcessBehaviour.cs" target="_blank" rel="external">IProcessBehaviour</a>. It uses the same interface as all process behaviours, it’s not a special little snowflake, and plugs into the architecture the same as every other component.</p>
<p>Crucially… this behaviour <strong>uses</strong> a context which <strong>has</strong> a service locator which this behaviour <strong>uses</strong> to obtain a topic store.</p>
<p>The behaviour, and all the other behaviours like it have naff all. The process context has everything. Any immutable config for the behaviour is injected by the service container from which the behaviour is obtained, and is a config level concern that remains the business of the behaviours author and for them to worry about. DI in this way is not the business, nor the concern of the framework. Service location is, and is provided via an interface on the context that can be implemented inside 10 minutes as a dictionary of lambdas if you had a pressing need.</p>
<h2 id="Service_location_and_dependency_injection_are_different_things">Service location and dependency injection are different things</h2>
<p>Obtaining a manifest from a database at runtime of service component names that conform to a generalised interface, obtaining them from the service container by name, and then executing them is the concern of a service locator, not DI. It’s not about one being better than the other, it’s about them being concerned with different things. Service location has an architectural impact on patterns of application composition. DI has an impact on configuring object instantiation.</p>
<p>The reason the two streams get crossed is that every DI offering that I have come across is built upon and predicated by a service locator. DI is one pattern that can be implemented with a service locator. So in almost every case you’re going to come across the two things in the same place called a “service container”. Use of service location will naturally co-mingle with DI, because reasoned use of DI is a wonderful thing, and shields our application from a lot of instantiation details, keeping them firmly ring-fenced as config.</p>
<p>To suggest that service location is an anti-pattern and DI is the one pattern (built upon service location) for all the things, is cargo-cultish.</p>
<p>Inversion and Conclave express service location and assume you will use whatever DI takes your fancy. What service locator and DI you choose to use is not my concern and should not impact the architecture.</p>
<h2 id="Looking-up_stuff">Looking-up stuff</h2>
<p>We as developers out of necessity seek guiding principles to inform our daily work. This isn’t exclusive to IT, we do it in all aspects of life. “A stitch in time saves nine”, is a truism that we may all find ourselves nodding to as its a useful sentiment. As is “measure twice, cut once” and “more speed less haste” despite there being subtle tensions between such truisms. They are useful principles. Their application requires wisdom and judgment. They are useful models, they are not innate laws of the cosmos… The map is not the terrain.</p>
<p>The assertion that service location is an anti-pattern masks consideration and balance of an underlying concern which I shall grandly entitle “looking-up stuff”. The issue isn’t one of service locators, database connections, sockets or access to the file-system. The issue is whether an operation should be looking up information external to itself, or whether it should be acting on only the information passed to it. Related to this, but beyond the scope of this piece is whether an operation should be yielding side-effects, and if it should, how they are managed.</p>
<p>There isn’t a simple answer to this concern because what is appropriate is contextual and determined by what the components role is whithin the broader system. Should my component pull information from an outside source, or should it be given that information? Should my parser be a <a href="https://www.google.co.uk/#q=pull+push+parser" target="_blank" rel="external">pull or push parser?</a> Whatever you decide is appropriate it is probably silly to call pull-parsing an anti-pattern when your push-parser has probably been built on top of one, despite the fact that in most cases you should probably be using a push-parser.</p>
<p>There is no universally applicable principle that will ensure we wear the mantle of “good developer”. There is no abdicating responsibility for the decisions we need to make not just as a programmers, but as system analysts even if you call yourself a developer. I become concerned when blanket truths replace consideration of context.</p>
<p>Service location is not an anti-pattern. There are anti-patterns that <strong>involve</strong> use of a service locator along with other similar constructs. There are anti patterns that involve the use of DI. Most devises we use in programming involve both (virtuous) patterns, and anti-patterns, which is really just a grand way of saying pros and cons. Generally speaking people who summarise the world in terms of only pros or only cons are said to be engaging in <a href="http://en.wikipedia.org/wiki/Splitting_(psychology%29" target="_blank" rel="external">splitting</a>.</p>
<blockquote>
<p>Splitting (also called black and white thinking or all-or-nothing thinking) is the failure in a person’s thinking to bring together both positive and negative qualities of the self and others into a cohesive, realistic whole. It is a common defense mechanism used by many people. The individual tends to think in extremes (i.e., an individual’s actions and motivations are all good or all bad with no middle ground.)</p>
</blockquote>
<p>I need to take a look about and see what discussions there may be on the subject of polarised views and whether they are more prevalent among programmers than other professions.</p>

      
    </div>
    <footer>
      
        
        
      
      
  
  <div class="tags">
    <a href="/tags/patterns/">patterns</a>, <a href="/tags/inversion/">inversion</a>
  </div>

      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-11-18T03:15:01.000Z"><a href="/2014/11/18/introducing-inversion/">Nov 18 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/11/18/introducing-inversion/">Introducing Inversion.</a></h1>
  

    </header>
    <div class="entry">
      
        <p><a href="https://github.com/guy-murphy/conclave-public" target="_blank" rel="external">Conclave</a> originally began life around 2004 as a .NET CMS built around <a href="http://en.wikipedia.org/wiki/Topic_Maps" target="_blank" rel="external">topicmaps</a>, and influenced heavily by the <a href="http://c2.com/cgi/wiki/wiki?WikiWikiWeb" target="_blank" rel="external">WikiWikiWeb</a>. It was a lot of fun but a personal side project, and was a little slow and clunky.</p>
<p>The next incarnation in 2006 was Acumen a .NET MVC web-application framework and CMS built with a team in Spain. Multi-tenant, multi-lingual and driving a couple of dozen public facing and internal extranet applications, Acumen was so much fun to develop and an incredible learning experience.</p>
<p>More recently in 2011 I began working on a behaviour oriented framework the purpose of which was to replace MVC within Conclave, so that feature-set just got rolled into Conclave. This left Conclave very schizophrenic and almost impossible to explain to any uninvolved person. Conclave simply seemed to be too many things.</p>
<p>So. The behavioural composition malarkey has been taken out of Conclave and is now <a href="https://github.com/guy-murphy/inversion-dev" target="_blank" rel="external">Inversion</a>. Conclave.CMS and Conclave.Funder will then simply be applications that use Inversion rather than being joined at the hip. This it is hoped will help keep our separation of concerns a little more honest.</p>
<p>Over the course of the Winter I’ll write some more about Inversion and it’s design goals.</p>

      
    </div>
    <footer>
      
        
        
      
      
  
  <div class="tags">
    <a href="/tags/inversion/">inversion</a>
  </div>

      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  

  <nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:guy-murphy.guthub.io">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/blog/">blog</a><small>1</small></li>
  
    <li><a href="/tags/inversion/">inversion</a><small>6</small></li>
  
    <li><a href="/tags/patterns/">patterns</a><small>6</small></li>
  
    <li><a href="/tags/practice/">practice</a><small>2</small></li>
  
    <li><a href="/tags/tools/">tools</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Guy Murphy
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'guy-murphy';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>