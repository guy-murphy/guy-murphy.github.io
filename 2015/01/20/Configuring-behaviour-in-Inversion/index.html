<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Configuring behaviour in Inversion | Weird Scenes Inside The Goldmine</title>
  <meta name="author" content="Guy Murphy">
  
  <meta name="description" content="Or, Experiments with black-box development.
I’ve recently overhauled both the way that Inversion configures behaviours and the way in which that confi">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Configuring behaviour in Inversion"/>
  <meta property="og:site_name" content="Weird Scenes Inside The Goldmine"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Weird Scenes Inside The Goldmine" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Weird Scenes Inside The Goldmine</a>, <small>...an obscurely titled development blog.</small></h1>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
      <li><a href="https://github.com/guy-murphy">Github</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-01-20T11:41:30.000Z"><a href="/2015/01/20/Configuring-behaviour-in-Inversion/">Jan 20 2015</a></time>
      
      
  
    <h1 class="title">Configuring behaviour in Inversion</h1>
  

    </header>
    <div class="entry">
      
        <p>Or, <em>Experiments with black-box development.</em></p>
<p>I’ve recently overhauled both the way that Inversion configures behaviours and the way in which that configuration is acted on as selection criteria when determining which behaviours should respond to an event. I thought I’d write this up as it keeps the small group of developers engaged with this work up-to-date, provides some informal documentation, and provides an illustration of a couple of Inversions design goals.</p>
<h2 id="You_need_to_know_where_the_goal_is_in_order_to_score">You need to know where the goal is in order to score</h2>
<p><em>TL;DR Make things as bendy, fast and easy to change as possible… Check that you are.</em></p>
<p>Inversion might have been labeled <em>Application stack number seven</em> as it sits on the back of six previous incarnations the first of which started in 2004 as an experiment in implementing MVC on the .NET platform, the decedent of which went live into production in 2006 where is remains to this day. Two other slightly earlier but very close incarnations of Inversion have gone into production in 2012 and 2014, but by this time the point of interest had moved well past MVC to playing with ideas of behavioural composition as a means of meeting cross-cutting concerns normally addressed by <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming" target="_blank" rel="external">AoP</a>.</p>
<p>So Inversion is merely the most recent of a series of application stacks experimenting with a handful of core ideas some of which are more developed than other at this point, but each of which should show progression rather than regression over time.</p>
<p>My experience tells me that any piece of development spanning more than a handful of weeks quickly starts accumulating the risk of it’s initial goals being diluted and then eventually forgotten. It is important then to remind ourselves what it is in broad terms we’re trying to obtain from a system, and then to review our activity and ensure we’re actually meeting those goals whether formally or informally.</p>
<p>This is a summary of some of Inversions goals :- </p>
<ul>
<li>Black-box components</li>
<li>Configuration as resource distinct from application</li>
<li>Favouring composition over inheritance for application behaviour</li>
<li>Small footprint micro-framework</li>
<li>Single responsibility</li>
<li>Extensibility, DIY</li>
<li>Substitution, <em>Plugability</em></li>
<li>Inversion of Control</li>
<li>Testability</li>
<li>Portability</li>
<li>Conventions for state</li>
<li>Speed</li>
</ul>
<p>Behaviour configuration will have a large impact on Inversion and will almost certainly add a distinct flavour to the frameworks usage for better or for worse, so it’s important once we’re done that we review our goals and ensure they’re being advanced and not diminished.</p>
<h2 id="Finding_a_common_abstraction_for_behaviour_configuration">Finding a common abstraction for behaviour configuration</h2>
<p><em>TL;DR Tuples.</em></p>
<p>Inversion is in large part a composition of <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Process/Behaviour/IProcessBehaviour.cs" target="_blank" rel="external">IProcessBehaviour</a> objects. A set of condition/action pairs. The relevant portion of the interface being:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// snipped out some members and comments for clarity</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> IProcessBehaviour {</div><div class="line">    <span class="keyword">string</span> RespondsTo { <span class="keyword">get</span>; }</div><div class="line">    <span class="keyword">bool</span> Condition(IEvent ev, IProcessContext context);</div><div class="line">    <span class="keyword">void</span> Action(IEvent ev, IProcessContext context);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>When we <code>context.Fire(event)</code> we pass the event to the condition of each behaviour registered with the context in turn. If the condition returns true, that behaviours action is executed on the context.</p>
<p>Over time we find a lot of common activity taking place in conditions.</p>
<ul>
<li>Does the context have any of these parameters?</li>
<li>Do these parameters and values exist on the context?</li>
<li>Do they exist on the event?</li>
<li>Do we have these keys in the contexts control-state?</li>
</ul>
<p>For want of a better phrase we call this the <em>selection criteria</em> of the behaviour.</p>
<p>So we quite naturally start to refactor common selection criteria into base classes. We also start to push out the specification of selection criteria to configuration of the behaviour.</p>
<p>In Inversions previous incarnation the expression of config for selection had gotten <a href="https://github.com/guy-murphy/conclave-public/blob/master/Conclave.Web/Behaviour/WebActionBehaviour.cs" target="_blank" rel="external">quite out of hand</a>. Each category of test ended up with its own data-structure both to configure and drive that test.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ImmutableList&lt;<span class="keyword">string</span>&gt; _includedAllControlStates;</div><div class="line"><span class="keyword">private</span> ImmutableList&lt;<span class="keyword">string</span>&gt; _nonIncludedControlStates;</div><div class="line"><span class="keyword">private</span> ImmutableList&lt;<span class="keyword">string</span>&gt; _includedAllParameters;</div><div class="line"><span class="keyword">private</span> ImmutableList&lt;<span class="keyword">string</span>&gt; _nonIncludedParameters;</div><div class="line"><span class="keyword">private</span> ImmutableDictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; _matchingAllParams;</div><div class="line"><span class="keyword">private</span> ImmutableDictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; _nonMatchingAllParams;</div></pre></td></tr></table></figure>

<p>This config would be injected in the constructor by the service container, and be acted upon by the behaviours condition.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Condition</span>(IEvent ev, IProcessContext context) {</div><div class="line">    <span class="keyword">bool</span> parmsAndValues = <span class="keyword">this</span>.MatchingAllParameters.All(p =&gt; </div><div class="line">        context.Params.Contains(p) && </div><div class="line">        context.Params[p.Key] == p.Value</div><div class="line">    );</div><div class="line">    <span class="keyword">bool</span> notParmsAndValues = <span class="keyword">this</span>.NonMatchingAllParameters.All(p =&gt; </div><div class="line">        context.Params.Keys.Contains(p.Key) && </div><div class="line">        context.Params[p.Key] != p.Value</div><div class="line">    );</div><div class="line">    <span class="keyword">bool</span> controlStates = <span class="keyword">this</span>.IncludedAllControlStates.All(p =&gt; </div><div class="line">        context.ControlState.Keys.Contains(p)</div><div class="line">    );</div><div class="line">    <span class="keyword">bool</span> notParms = <span class="keyword">this</span>.NonIncludedParameters.All(p =&gt; </div><div class="line">        !context.Params.Keys.Contains(p)</div><div class="line">    );</div><div class="line">    <span class="keyword">bool</span> notControlStates = <span class="keyword">this</span>.NonIncludedControlStates.All(p =&gt; </div><div class="line">        !context.ControlState.Keys.Contains(p)</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">return</span> </div><div class="line">        <span class="keyword">base</span>.Condition(ev, context) && </div><div class="line">        parms && </div><div class="line">        parmsAndValues && </div><div class="line">        notParmsAndValues && </div><div class="line">        controlStates && </div><div class="line">        notParms && </div><div class="line">        notControlStates;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>It worked, but it wasn’t extensible in that to extend the functionality required adding more and more data-structures, with less and less common purpose. It put a lot of pressure on inheritance to both pick up config you were interested in, along with it’s condition checks. It was riddled with assumptions which you either accepted or were left with no functionality except a bespoke implementation. Special little snowflakes everywhere, which is the opposite of what is being attempted.</p>
<p>It worked in that it allowed specifying behaviour selection criteria from config but the expression of these configs in Spring.NET or in code, was painful, hard to understand, and messy. Worst it was leaking implementation details from the behaviours across their interface.</p>
<p>So I started playing around with something along the lines of <code>IDictionary&lt;string, IDictionary&lt;string, IDictionary&lt;string, IList&lt;string&gt;&gt;&gt;&gt;</code>, which again kind of worked. It was an improvement in that the previous configurations for selection criteria could all pretty much be expressed with the one data-structure. The data-structure however was messy, and difficult to express in configuration.</p>
<p>Next I started playing with a structure something like, <code>MultiKeyValue&lt;string, string, string, string&gt;</code> which finally started to feel in some way rational and self contained. I happened to be reading a piece comparing the efficiency of hashcodes between key-value pairs and tuples which made obvious a very short step to <code>Configuration.Element : Tuple&lt;int, string, string, string, string&gt;</code>.</p>
<p>The class <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Process/Configuration.cs" target="_blank" rel="external">Inversion.Process.Configuration</a> represents a set of ordered elements, or a relation of tuples expressing <code>(ordinal, frame, slot, name, value)</code>. This is a very expressive structure, and with LINQ easy and efficient to query in lots of different ways.</p>
<p>The resulting configuration is easy to express in code, and encourages a declarative rather than fluent style.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">Naiad.ServiceContainer.Instance.RegisterService(<span class="string">"test-behaviours"</span>,</div><div class="line">    container =&gt; {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> List&lt;IProcessBehaviour&gt; {</div><div class="line">            <span class="keyword">new</span> MessageTraceBehaviour(<span class="string">"*"</span>, </div><div class="line">                <span class="keyword">new</span> Configuration.Builder {</div><div class="line">                    {<span class="string">"event"</span>, <span class="string">"match"</span>, <span class="string">"trace"</span>, <span class="string">"true"</span>}</div><div class="line">                }</div><div class="line">            ),</div><div class="line">            <span class="keyword">new</span> ParameterisedSequenceBehaviour(<span class="string">"test"</span>, </div><div class="line">                <span class="keyword">new</span> Configuration.Builder {</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"bootstrap"</span>},</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"parse-request"</span>},</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"work"</span>},</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"view-state"</span>},</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"process-views"</span>},</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"render"</span>}</div><div class="line">                }</div><div class="line">            ),</div><div class="line">            <span class="keyword">new</span> ParameterisedSequenceBehaviour(<span class="string">"work"</span>, </div><div class="line">                <span class="keyword">new</span> Configuration.Builder {</div><div class="line">                    {<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test1"</span>},</div><div class="line">                    {<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test2"</span>},</div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"work-message-one"</span>, <span class="string">"trace"</span>, <span class="string">"true"</span>}, </div><div class="line">                    {<span class="string">"fire"</span>, <span class="string">"work-message-two"</span>, <span class="string">"trace"</span>, <span class="string">"true"</span>}</div><div class="line">                }</div><div class="line">            ),</div><div class="line">            <span class="keyword">new</span> ParseRequestBehaviour(<span class="string">"parse-request"</span>),</div><div class="line">            <span class="keyword">new</span> BootstrapBehaviour(<span class="string">"bootstrap"</span>, </div><div class="line">                <span class="keyword">new</span> Configuration.Builder {</div><div class="line">                    {<span class="string">"context"</span>, <span class="string">"set"</span>, <span class="string">"area"</span>, <span class="string">"default"</span>},</div><div class="line">                    {<span class="string">"context"</span>, <span class="string">"set"</span>, <span class="string">"concern"</span>, <span class="string">"default"</span>},</div><div class="line">                    {<span class="string">"context"</span>, <span class="string">"set"</span>, <span class="string">"action"</span>, <span class="string">"default"</span>},</div><div class="line">                    {<span class="string">"context"</span>, <span class="string">"set"</span>, <span class="string">"appPath"</span>, <span class="string">"/web.harness"</span>}</div><div class="line">                }</div><div class="line">            ),</div><div class="line">            <span class="keyword">new</span> ViewStateBehaviour(<span class="string">"view-state"</span>),</div><div class="line">            <span class="keyword">new</span> ProcessViewsBehaviour(<span class="string">"process-views"</span>, </div><div class="line">                <span class="keyword">new</span> Configuration.Builder {</div><div class="line">                    {<span class="string">"config"</span>, <span class="string">"default-view"</span>, <span class="string">"xml"</span>}</div><div class="line">                }</div><div class="line">            ),</div><div class="line">            <span class="keyword">new</span> RenderBehaviour(<span class="string">"render"</span>),</div><div class="line">            <span class="keyword">new</span> JsonViewBehaviour(<span class="string">"json::view"</span>, <span class="string">"text/json"</span>),</div><div class="line">            <span class="keyword">new</span> XmlViewBehaviour(<span class="string">"xml::view"</span>, <span class="string">"text/xml"</span>),</div><div class="line">            <span class="keyword">new</span> XsltViewBehaviour(<span class="string">"xslt::view"</span>, <span class="string">"text/xml"</span>),</div><div class="line">            <span class="keyword">new</span> XsltViewBehaviour(<span class="string">"xsl::view"</span>, <span class="string">"text/html"</span>),</div><div class="line">            <span class="keyword">new</span> StringTemplateViewBehaviour(<span class="string">"st::view"</span>, <span class="string">"text/html"</span>)</div><div class="line">        };</div><div class="line">    }</div><div class="line">);</div></pre></td></tr></table></figure>

<p>Not the best notational representation ever of configuration, but not the worst, a definite improvement, and something it’s felt one can become comfortable with. It’s certainly a very concise configuration of a swathe of behaviour. </p>
<p>This also is not the primary means of configuration. This is showing the configuration of <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Naiad/ServiceContainer.cs" target="_blank" rel="external">Naiad</a> which is a toy service container Inversion provides suitable for use in unit tests. The above is the <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Web.Tests/Behaviour/ViewPipelineTests.cs" target="_blank" rel="external">configuration of a test</a>.</p>
<p>A good friend and former colleague (Adam Christie) is getting good results from the prototype of a service container called <em>Pot</em>, intended to replace the use of Spring.NET. Until that matures over the coming months, Spring.NET is the favoured service container for Inversion. This doesn’t stop you from from using whichever service container takes your fancy as <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Process/IServiceContainer.cs" target="_blank" rel="external">IServiceContainer</a> shows, Inversions own expectations of a service container are minimal. </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> IServiceContainer : IDisposable {</div><div class="line">    T GetService&lt;T&gt;(<span class="keyword">string</span> name) <span class="keyword">where</span> T: class;</div><div class="line">    <span class="keyword">bool</span> ContainsService(<span class="keyword">string</span> name);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>If you can honour that interface (and you can) with your service container, Inversion wont know any difference.</p>
<p>What I mean when I say Spring.NET is the favoured service container is that out of all the possibilities, Spring.NET is what I happen to be focused on as a baseline.</p>
<h2 id="Acting_on_configuration_for_conditions">Acting on configuration for conditions</h2>
<p><em>TL;DR LINQ</em></p>
<p><a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Process/Behaviour/BehaviourConditionPredicates.cs" target="_blank" rel="external">BehaviourConditionPredicates</a> provides a bunch of predicates as extension methods that take the form:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">ContextMatchesAnyParamValues</span>(</div><div class="line">    <span class="keyword">this</span> IConfiguredBehaviour self, IProcessContext ctx</div><div class="line">) {</div><div class="line">    IEnumerable&lt;IConfigurationElement&gt; elements = self.Configuration.GetElements(<span class="string">"context"</span>, <span class="string">"match-any"</span>);</div><div class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">foreach</span> (IConfigurationElement element <span class="keyword">in</span> elements) {</div><div class="line">        i++;</div><div class="line">        <span class="keyword">if</span> (ctx.HasParamValue(element.Name, element.Value)) <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> i == <span class="number">0</span>; <span class="comment">// there was no match specified</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>Which illustrates extending <code>IConfiguredBehaviour</code> for whatever condition predicates are useful over time, without having to modify <code>IConfiguredBehaviour</code> or <code>Configuration</code>. We establish our own convention of tuples, and act on them. In the above example we’re extracting elements from the configuration  that have the frame and slot <code>{&quot;context&quot;, &quot;match&quot;}</code> which drops out the tuples:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">{<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test1"</span>},</div><div class="line">{<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test2"</span>}</div></pre></td></tr></table></figure>

<p>We check the context for the <code>name</code> and <code>value</code> of each tuple with <code>ctx.HasParamValue(element.Name, element.Value)</code>. </p>
<p>You’re always free to write the conditions for your behaviours in whatever way you need. What we see here is only an illustration of how I happen to be tackling it.</p>
<h2 id="Expressing_tuples_as_XML">Expressing tuples as XML</h2>
<p><em>TL;DR Just read four nodes deep and call them tuple elements.</em></p>
<p>If you step back from XML a moment and consider it simply as an expression of a tree of nodes, there’s a trick you can pull with reading a tree of nodes as tuples which is a little novel in this context but which we take for granted when working with relational databases. That is databases that focus on the grouping of tuples into collections which we call relations, or more commonly tables… I’ll confess to that piece of conceit straight-away. I happened to be doing some reading on working with sets of tuples and ran across the fact that the <em>relational</em> in “relational database” refers to the fact that it’s the set of tuples that are a <em>relation</em>, commonly called table, not any association between tables as you might expect from the term. Was novel to me, and I now obviously like flaunting the term… Back on topic…</p>
<p>Given that our configuration is made up of a set of tuples the elements of which we’re calling <code>(frame, slot, name, value)</code>, consider the following XML:-</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">    <span class="tag">&lt;<span class="title">context</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">match-any</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">action</span>&gt;</span>test1<span class="tag">&lt;/<span class="title">action</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">action</span>&gt;</span>test2<span class="tag">&lt;/<span class="title">action</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">match-any</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">context</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">fire</span>&gt;</span>                  </div><div class="line">        <span class="tag">&lt;<span class="title">work-message-one</span> <span class="attribute">trace</span>=<span class="value">"true"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">work-message-two</span> <span class="attribute">trace</span>=<span class="value">"true"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">fire</span>&gt;</span></div><div class="line">...</div></pre></td></tr></table></figure>

<p>If we read that one node at a time, and with each node copy it as an element of our tuple, our first tuple builds up thus:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">context     =&gt;  {<span class="string">"context"</span>}</div><div class="line">match-any   =&gt;  {<span class="string">"context"</span>, <span class="string">"match-any"</span>}</div><div class="line">action      =&gt;  {<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>}</div><div class="line">test1       =&gt;  {<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test1"</span>}</div></pre></td></tr></table></figure>

<p>And we have our first tuple. Now if we were reading results from a database, we’d not be surprised if the next value <code>value2</code> were preceded by the same elements, as they are unchanged. So our second tuple is <code>{&quot;context&quot;, &quot;match-any&quot;, &quot;action&quot;, &quot;test2&quot;}</code>. In this way we can read that XML snippet as:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">{<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test1"</span>},</div><div class="line">{<span class="string">"context"</span>, <span class="string">"match-any"</span>, <span class="string">"action"</span>, <span class="string">"test2"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"work-message-one"</span>, <span class="string">"trace"</span>, <span class="string">"true"</span>}, </div><div class="line">{<span class="string">"fire"</span>, <span class="string">"work-message-two"</span>, <span class="string">"trace"</span>, <span class="string">"true"</span>}</div></pre></td></tr></table></figure>

<p>Which is exactly what we’re after. We can now define a set of tuples very expressively and in an extensible manner with XML, we now just need to hook this up with Spring.</p>
<h2 id="Extending_Spring-NET_configuration">Extending Spring.NET configuration</h2>
<p><em>TL;DR Was much easier than expected.</em></p>
<p>I’ve been using Spring.NET since 2006 as the backbone of most applications I’ve built. It’s something of a behemoth, and the reality is I’ve only really ever used a very thin slice of its features. I’ve always been comforted by the fact that there’s a solution to most problems with Spring and if I needed to I could extend my way out of a tight space, despite the fact I’ve never had much call to.</p>
<p>One of the things I’ve always wanted to do was extend and customise Spring xml configuration. If you’re working with Spring and xml configs one of the costs is you’re going to end up with a lot of configuration and it’s got a fair few sharp edges to it. After having a stab at it I can only say I wish I’d done it years ago as it was far less involved than I expected.</p>
<p>The relevant documentation for this is <a href="http://springframework.net/docs/1.1.2/reference/html/extensible-xml.html" target="_blank" rel="external">Appendix B. Extensible XML authoring</a> which lays out in pretty straight-forward terms what needs to be done. From this we produce:-</p>
<h3 id="An_XSD_schema_describing_our_extension_of_the_Spring_config">An XSD schema describing our extension of the Spring config</h3>
<ul>
<li><a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Spring/behaviour.xsd" target="_blank" rel="external">behaviour.xsd</a> </li>
</ul>
<p>Which provides the schema for our config extension, and most importantly associates it with a namespace. This is our “what”.</p>
<p>There a small gotcha here. You need to go to the file properties at set <em>Build action</em> to <em>Embedded resource</em>, as you’re schema needs to be embedded in the assembly for it to be used.</p>
<h3 id="A_parser_for_our_namespace">A parser for our namespace</h3>
<ul>
<li><a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Spring/BehaviourNamespaceParser.cs" target="_blank" rel="external">BehaviourNamespaceParser</a></li>
</ul>
<p>Which is responsible for mapping individual xml elements to the unit of code that will process them. For each xml element you register its handler, thus:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.RegisterObjectDefinitionParser(<span class="string">"view"</span>, <span class="keyword">new</span> ViewBehaviourObjectDefinationParser());</div></pre></td></tr></table></figure>

<p>This is our link between “what” and “how”.</p>
<h3 id="An_object_definition_parser">An object definition parser</h3>
<ul>
<li><a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Spring/BehaviourObjectDefinationParser.cs" target="_blank" rel="external">BehaviourObjectDefinationParser</a></li>
<li><a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Spring/ViewBehaviourObjectDefinationParser.cs" target="_blank" rel="external">ViewBehaviourObjectDefinationParser</a></li>
</ul>
<p>This is our “how”, where the actual work gets done. In these object definition parsers we process the xml and drive an <code>ObjectDefinitionBuilder</code> provided by Spring.</p>
<p>If we consider a simple example of this implementation in <code>ViewBehaviourObjectDefinationParser</code>. First we override <code>GetObjectTypeName</code>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">string</span> <span class="title">GetObjectTypeName</span>(XmlElement element) {</div><div class="line">    <span class="keyword">return</span> element.GetAttribute(<span class="string">"type"</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>When our element <code>view</code> is encountered and <code>ViewBehaviourObjectDefinationParser</code> is resolved from its registration for this element, Spring asks for a string expression of the type for the object that will be created for this element. We simply read this from the elements <code>@type</code> attribute, exactly as Spring normally would.</p>
<p>Next we need to deal with any constructor injection, and it turns out that because we’re processing elements in our own namespace, elements from Springs namespace still work as expected, allowing us to mix and match to some extent.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">behaviour</span> <span class="attribute">responds-to</span>=<span class="value">"parse-request"</span> </span></div><div class="line">    <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.ParseRequestBehaviour, Inversion.Web"</span></div><div class="line">&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">spring:constructor-arg</span> </span></div><div class="line">        <span class="attribute">name</span>=<span class="value">"appDirectory"</span> </div><div class="line">        <span class="attribute">value</span>=<span class="value">"Inversion.Web.Harness.Site"</span> </div><div class="line">    /&gt;</div><div class="line"><span class="tag">&lt;/<span class="title">behaviour</span>&gt;</span></div></pre></td></tr></table></figure>

<p>Note the <code>spring:constructor-arg</code> within the <code>behaviour</code> element.</p>
<p>So we’re in the rather comfy position of retaining Springs base functionality in this area and merely adding syntactic sugar where it suits us.</p>
<p>Spring calls <code>DoParse</code> on our definition parser, and passes it the associated element.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoParse</span>(XmlElement xml, ObjectDefinitionBuilder builder) {</div><div class="line">    <span class="comment">// all behaviours with config being parsed have @respondsTo</span></div><div class="line">    <span class="keyword">string</span> respondsTo = xml.GetAttribute(<span class="string">"responds-to"</span>);</div><div class="line">    builder.AddConstructorArg(respondsTo);</div><div class="line"></div><div class="line">    <span class="comment">// all view behaviours have @content-type</span></div><div class="line">    <span class="keyword">string</span> contentType = xml.GetAttribute(<span class="string">"content-type"</span>);</div><div class="line">    builder.AddConstructorArg(contentType);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>In this example we are extracting the <code>@responds-to</code> and <code>@content-type</code> attributes and adding them to the object definition builder as constructor arguments.</p>
<h3 id="Reading_the_behaviour_configuration_from_XML">Reading the behaviour configuration from XML</h3>
<p>Okay, so if we take stock, we’re by this point able to provide our own expressions in XML of object definitions. This doesn’t speak to our provision of a set of tuples as configuration for a behaviour.</p>
<p><a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Spring/BehaviourObjectDefinationParser.cs" target="_blank" rel="external">BehaviourObjectDefinationParser</a> is a little more gnarly than our definition parser for view behaviours, but it’s <code>DoParse</code> isn’t too wild. We iterate over the xml nodes and construct a hashset of tuples from them, and once we have them we call <code>builder.AddConstructorArg(elements)</code> to tell Spring that we’re using them as the next constructor argument.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// we're going to read the config into tuples</span></div><div class="line"><span class="comment">// of frame, slot, name, value</span></div><div class="line"><span class="keyword">foreach</span> (XmlElement frameElement <span class="keyword">in</span> frames) {</div><div class="line">    <span class="keyword">string</span> frame = frameElement.Name;</div><div class="line"></div><div class="line">    <span class="comment">// process any frame attributes as &lt;frame slot="name" /&gt;</span></div><div class="line">    <span class="keyword">foreach</span> (XmlAttribute pair <span class="keyword">in</span> frameElement.Attributes) {</div><div class="line">        <span class="keyword">string</span> slot = pair.Name;</div><div class="line">        <span class="keyword">string</span> name = pair.Value;</div><div class="line">        Configuration.Element element = <span class="keyword">new</span> Configuration.Element(ordinal, frame, slot, name, String.Empty);</div><div class="line">        elements.Add(element);</div><div class="line">        ordinal++;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> (XmlElement slotElement <span class="keyword">in</span> frameElement.ChildNodes) {</div><div class="line">        <span class="keyword">string</span> slot = slotElement.Name;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> start = elements.Count;</div><div class="line">        <span class="comment">// read children of slot as &lt;name&gt;value&lt;/name&gt;</span></div><div class="line">        <span class="keyword">foreach</span> (XmlElement pair <span class="keyword">in</span> slotElement.ChildNodes) {</div><div class="line">            <span class="keyword">string</span> name = pair.Name;</div><div class="line">            <span class="keyword">string</span> <span class="keyword">value</span> = pair.InnerText;</div><div class="line">            Configuration.Element element = <span class="keyword">new</span> Configuration.Element(ordinal, frame, slot, name, <span class="keyword">value</span>);</div><div class="line">            elements.Add(element);</div><div class="line">            ordinal++;</div><div class="line">        }</div><div class="line">        <span class="comment">// read attributes of slot as name="value"</span></div><div class="line">        <span class="keyword">foreach</span> (XmlAttribute pair <span class="keyword">in</span> slotElement.Attributes) {</div><div class="line">            <span class="keyword">string</span> name = pair.Name;</div><div class="line">            <span class="keyword">string</span> <span class="keyword">value</span> = pair.Value;</div><div class="line">            Configuration.Element element = <span class="keyword">new</span> Configuration.Element(ordinal, frame, slot, name, <span class="keyword">value</span>);</div><div class="line">            elements.Add(element);</div><div class="line">            ordinal++;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (elements.Count == start) { <span class="comment">// the slot had no name/value pairs</span></div><div class="line">            Configuration.Element element = <span class="keyword">new</span> Configuration.Element(ordinal, frame, slot, String.Empty, String.Empty);</div><div class="line">            elements.Add(element);</div><div class="line">            ordinal++;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line">builder.AddConstructorArg(elements);</div></pre></td></tr></table></figure>

<p>Nothing clever happening here at all, left rather verbose and explicit to assist with debugging.</p>
<p>So we have our behaviours configurations nicely integrated with Spring, and with reasonable opportunity for extension.</p>
<p>Lastly from our <code>behaviour.xsd</code> schema we can default attribute values for elements, as we do for <code>message-sequence@type</code>:-</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">xsd:element</span> <span class="attribute">name</span>=<span class="value">"message-sequence"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">xsd:complexType</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">xsd:complexContent</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">xsd:extension</span> <span class="attribute">base</span>=<span class="value">"configured-behaviour-type"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="title">xsd:attribute</span> <span class="attribute">name</span>=<span class="value">"type"</span> <span class="attribute">type</span>=<span class="value">"xsd:string"</span> <span class="attribute">use</span>=<span class="value">"optional"</span> <span class="attribute">default</span>=<span class="value">"Inversion.Process.Behaviour.ParameterisedSequenceBehaviour, Inversion.Process"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="title">xsd:extension</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">xsd:complexContent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">xsd:complexType</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">xsd:element</span>&gt;</span></div></pre></td></tr></table></figure>

<p>This allows us to write <code>message-sequence</code> with it’s <code>@type</code> value supplied by the schema.</p>
<p>The end result of these extenstions is the ability to express cleanly in XML the equivalent of our in code configuration of behaviours, as can be seen in <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Web.Harness.Site/behaviours.config" target="_blank" rel="external">behaviour.config</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">spring:list</span>  <span class="attribute">element-type</span>=<span class="value">"Inversion.Process.Behaviour.IProcessBehaviour, Inversion.Process"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="title">message-sequence</span> <span class="attribute">responds-to</span>=<span class="value">"process-request"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">fire</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">bootstrap</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">parse-request</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">work</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">view-state</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">process-views</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">render</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">fire</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">message-sequence</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="title">behaviour</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"bootstrap"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.BootstrapBehaviour, Inversion.Web"</span></div><div class="line">    &gt;</div><div class="line">        <span class="tag">&lt;<span class="title">context</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">set</span> </span></div><div class="line">                <span class="attribute">area</span>=<span class="value">"default"</span> </div><div class="line">                <span class="attribute">concern</span>=<span class="value">"default"</span> </div><div class="line">                <span class="attribute">action</span>=<span class="value">"default"</span> </div><div class="line">                <span class="attribute">appPath</span>=<span class="value">"/web.harness"</span> </div><div class="line">            /&gt;</div><div class="line">        <span class="tag">&lt;/<span class="title">context</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">behaviour</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="title">behaviour</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"parse-request"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.ParseRequestBehaviour, Inversion.Web"</span></div><div class="line">    &gt;</div><div class="line">        <span class="tag">&lt;<span class="title">spring:constructor-arg</span> <span class="attribute">name</span>=<span class="value">"appDirectory"</span> <span class="attribute">value</span>=<span class="value">"Inversion.Web.Harness.Site"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">behaviour</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="title">behaviour</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"view-state"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.ViewStateBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="title">behaviour</span>  </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"process-views"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.ProcessViewsBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="title">behaviour</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"render"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.RenderBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- VIEWS --&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="title">view</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"rzr::view"</span> </div><div class="line">        <span class="attribute">content-type</span>=<span class="value">"text/html"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.View.RazorViewBehaviour, Inversion.Web"</span></div><div class="line">    /&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">view</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"xml::view"</span> </div><div class="line">        <span class="attribute">content-type</span>=<span class="value">"text/xml"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.View.XmlViewBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">view</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"json::view"</span> </div><div class="line">        <span class="attribute">content-type</span>=<span class="value">"text/json"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.View.JsonViewBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">view</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"xslt::view"</span> </div><div class="line">        <span class="attribute">content-type</span>=<span class="value">"text/xml"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.View.XsltViewBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">view</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"xsl::view"</span> </div><div class="line">        <span class="attribute">content-type</span>=<span class="value">"text/html"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.Web.Behaviour.View.XsltViewBehaviour, Inversion.Web"</span> </div><div class="line">    /&gt;</div><div class="line">    <span class="tag">&lt;<span class="title">view</span> </span></div><div class="line">        <span class="attribute">responds-to</span>=<span class="value">"st::view"</span> </div><div class="line">        <span class="attribute">content-type</span>=<span class="value">"text/html"</span> </div><div class="line">        <span class="attribute">type</span>=<span class="value">"Inversion.StringTemplate.Behaviour.View.StringTemplateViewBehaviour, Inversion.StringTemplate"</span> </div><div class="line">    /&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- app --&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="title">message-trace</span> <span class="attribute">responds-to</span>=<span class="value">"*"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">event</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">match</span> <span class="attribute">trace</span>=<span class="value">"true"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">event</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">message-trace</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="title">message-sequence</span> <span class="attribute">responds-to</span>=<span class="value">"work"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">context</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">match-any</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="title">action</span>&gt;</span>test1<span class="tag">&lt;/<span class="title">action</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="title">action</span>&gt;</span>test2<span class="tag">&lt;/<span class="title">action</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="title">match-any</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">context</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">fire</span>&gt;</span>                  </div><div class="line">            <span class="tag">&lt;<span class="title">work-message-one</span> <span class="attribute">trace</span>=<span class="value">"true"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">work-message-two</span> <span class="attribute">trace</span>=<span class="value">"true"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">fire</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">message-sequence</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="title">spring:list</span>&gt;</span></div></pre></td></tr></table></figure>

<p>Which can be compared with a <a href="https://github.com/guy-murphy/inversion-dev/blob/55e8e6b302016c4c805a376a29abb4cccb3eb599/Inversion.Web.Harness.Site/behaviours.config" target="_blank" rel="external">previous version</a>. The difference is stark.</p>
<p>We can also see here both the beginning of our own domain specific language in the configuration of our behaviours, but more importantly the ability for other developers to extend this with their own semantics. </p>
<p>Consider the following definition of a behaviour:-</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">some-behaviour</span> <span class="attribute">responds-to</span>=<span class="value">"something"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">resource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">exist</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="title">path</span>&gt;</span>Resources/Results/result-1-1.xml<span class="tag">&lt;/<span class="title">path</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="title">exists</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">resource</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">some-behaviour</span>&gt;</span></div></pre></td></tr></table></figure>

<p>I just made that up, but hopefully it begins to become clear how that will be read as a set of tuples for the behaviours configuration that I can act on. You can make your own stuff up, which is what open for extension means. The ability for you to make stuff up, that I didn’t foresee and without you having to ask me to modify my stuff.</p>
<p>There’s a strong smell of Prolog around here now. If you’re familiar with Prolog, think of assertions upon which predicates act.</p>
<h3 id="A_little_caveat_on_reading_XML_as_a_set_of_tuples">A little caveat on reading XML as a set of tuples</h3>
<p>In a relation of tuples you can’t have a duplicate tuple, so tuples that are repeated are collapsed down to the one tuple. The consequence of this is you can’t do…</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">{<span class="string">"fire"</span>, <span class="string">"bootstrap"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"parse-request"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"work"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"work"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"work"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"view-state"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"process-views"</span>},</div><div class="line">{<span class="string">"fire"</span>, <span class="string">"render"</span>}</div></pre></td></tr></table></figure>

<p>As you’ll end up with just the one <code>{&quot;fire&quot;, &quot;work&quot;}</code> tuple. The elements as implemented express an ordinal so it is possible to change this to allow duplicate tuples but I want to digest what the implications of that might be first, and to wait and see what if any pain it actually may cause in practice, before fixing something that may not be broke.</p>
<p>You could as stands move past this problem by moving to something like <code>{&quot;fire-repeat&quot;, &quot;work&quot;, &quot;3&quot;}</code>.</p>
<p>We have enough here to feel confident in adapting to our needs in this area over time. We’re not walled in if we experience pain in this.</p>
<h2 id="Reviewing_our_goals">Reviewing our goals</h2>
<p><em>TL;DR It went rather well, or I’d not be writing about it.</em></p>
<p>I listed a bunch of goal, principles or aspirations that are important to Inversion. I find it important after a non-trivial piece of work to consciously run down a mental check-list and ensure that I’m not negatively impacting any of those goals without compelling reason. The purpose of such a review is not to seek perfection but to ensure simple forward progress in each area, even if it’s only inching forward. Incremental improvement, <a href="http://en.wikipedia.org/wiki/Kaizen" target="_blank" rel="external">kaizen</a> and all that.</p>
<p>This is just my sharing informal observations after a piece of work. Normally I would use my internal dialogue.</p>
<ul>
<li><p><em>Black-box components</em></p>
<p>  Inversion has a strong opinion on behaviours as black boxes being as opaque as possible. This is why we don’t inject implementation components into behaviours, and encourage behaviours to use service location to locate the component they need for their implementation. The reasons for this are outlined in other pieces I’ve written and is something I’ll write about more in the future. The short version is a concern with leaking implementation details, and imposing externally visible <em>has-a</em> relationships upon components where <em>uses-a</em> would be more appropriate. A behaviour may use configuration to form the basis of component location, but that is a detail of implementation not common interface.</p>
<p>  This concern speaks to behaviours only. How data-access components obtained from an IoC container are instantiated and injected for example is a separate and distinct architectural concern. Behaviours are participating in a component model around which there are specific expectations. Other services aren’t.</p>
<p>  Anything that distracts from a behaviours condition and action is a potentially undesirable overhead, especially if its leaking details across the interface. Moving from multiple data-structures to the one whose interface does not express intent, focuses on being a simple, generalised, immutable structure of string values that can serve multiple purposes… While not a radical improvement in terms of behaviours as black-boxes, it’s a definite improvement. We’re leaking less. Configuration becomes a standardised input at instantiation.</p>
<p>  Intent is expressed where desirable through the data-structures actual data, not it’s interface. This is what is meant by moving to a more generalised data-structure.</p>
</li>
<li><p><em>Substitution, “pluggability</em></p>
<p>  Related to the interest in black-boxes, this isn’t a <a href="http://en.wikipedia.org/wiki/Liskov_substitution_principle" target="_blank" rel="external">Liskov</a> concern. This is a very real and practical concern with being able to swap out components with alternate implementations. Change the type specified by that attribute and nothing else needs to change kind of swapping out. Behaviours as extensible <a href="http://www.martinfowler.com/eaaCatalog/plugin.html" target="_blank" rel="external">plugins</a>.</p>
<p>  Again no tectonic shift here, as with the previous point, the focus of many interfaces into one common interface shared by many behaviours provides substantially less friction to behaviours as plugins.</p>
</li>
<li><p><em>Configuration as resource distinct from application</em></p>
<p>  Expressing configuration is more standardised, expressive, and more elegant especially when using XML notation thanks to the Spring.NET extensions. The change is impactful enough that we’re now starting as a natural matter of course to express our own semantics through configuration.</p>
<p>  So while configuration has not been made any more distinct as a resource, the quality of it’s use as a distinct resource has been much improved, and I have hope that it will over time become a pleasure to use and a welcome tool for the developer rather than an onerous liability.</p>
</li>
<li><p><em>Favouring composition over inheritance for application behaviour</em></p>
<p>  With the original implementation there was a lot of pressure to inherit from various classes in order to inherit some of their configuration features. This caused a lot of strain on inheritance.</p>
<p>  With the move to a common data-structure for configuration we took away pressure from inheriting to gain varying configuration properties.</p>
<p>  With the move to predicates as methods extending <code>IConfiguredBehaviour</code> we took pressure from having to inherit from a particular class in order to pick up it’s condition predicates.</p>
<p>  What we didn’t escape was the need to actually use these predicates in a condition, therefore making it desirable to inherit from some classes in order to obtain the checks they perform in their condition.</p>
<p>  So this is really a 2 out of 3 in this regard. We have relieved pressure from inheritance in quite a marked way, but there remains an impediment that will require more thought and work.</p>
</li>
</ul>
<ul>
<li><p><em>Small footprint micro-framework</em></p>
<p>  This was one of the primary reasons for the piece of work and one of the more substantial wins as it’s reduced down the footprint of the behaviour interface and provides a strategy for accommodating future change without modification. Behaviour configuration is in a markedly better state than it was. Far more compact in design.</p>
</li>
<li><p>Single responsibility</p>
<p>  Providing configuration features was starting to distract from a behaviours responsibility to provide a condition/action pair, with an emphasis on the action. Most of the responsibility for expressing configuration and working with it has been removed from the behaviour which for the most part now merely has a configuration that was provisioned by a base class and is acted on by extension methods. So our focus on the actual responsibility of behaviours has been tightened.</p>
</li>
<li><p><em>Extensibility, DIY</em></p>
<p>  This again was one of the primary reasons for performing this piece of work. There was a desire in the face of feature requests concerning configuration and predicates to be able to reasonably reply “do it yourself”.</p>
<p>  On the one hand there’s a big gain. <a href="http://en.wikipedia.org/wiki/Resource_Description_Framework" target="_blank" rel="external">RDF</a> is able to describe the world with triples, and it turns out <a href="http://www.w3.org/TR/n-quads/" target="_blank" rel="external">N-Quads</a> is a thing. The point is, in terms of data expression you can drive a Mongolian Horde though an ordered set of four element tuples. It makes it very easy for other developers to extend with their own configuration expressions.</p>
<p>  As mentioned previously adding new predicates as extension methods is now also smooth.</p>
<p>  We’re still stuck on having to actually use these predicates as mentioned.</p>
<p>  The issue isn’t implementing the lookup of predicate strategies, it can be as simple as a dictionary of lambdas, the cause for concern is where to define this, and where to inject it. Which object should be responsible for maintaining this lookup? It probably fits well enough on the context, but it would require the context to hold implementation details of behaviours, and I want to think about that some.</p>
</li>
<li><p><em>Inversion of Control</em></p>
<p>  I’m not sure I would go so far as to say IoC has been significantly enhanced here. Behaviour implementations have certainly relinquished much of their control over their configuration. Perhaps a nudge in the right direction for IoC is that it is now easier for developers to drive both their condition and action from configuration, so we have perhaps afforded more opportunity for IoC.</p>
</li>
<li><p><em>Testability</em></p>
<p>  No big wins in functional terms here, the more concise and expressive configuration is simply easier and more pleasant to use, so unit tests for example that would tend to want to configure a wide variety of cases and so are big users of configuration certainly benefit.</p>
<p>  While I was rummaging around the framework touching lots of different bits to implement <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Web/MockWebContext.cs" target="_blank" rel="external">MockWebContext</a> along with <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Web/MockWebRequest.cs" target="_blank" rel="external">MockWebRequest</a> and <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Web/MockWebResponse.cs" target="_blank" rel="external">MockWebResponse</a> as I had a need to lay down some half-decent tests. Nothing exciting, you can see their use in <a href="https://github.com/guy-murphy/inversion-dev/blob/master/Inversion.Web.Tests/Behaviour/ViewPipelineTests.cs" target="_blank" rel="external">ViewPipelineTests</a>. So overall this patch of work puts Inversion it quite a strong position for testing with it possible to test contexts running a full application life-cycle for a request, or any behaviour or group of behaviours in concert as needed. Very few behaviours have a dependency on <code>HttpContext</code>, in this case only those parsing the request and writing the response, so testing even a view pipeline is straight-forward.</p>
</li>
<li><p><em>Portability</em></p>
<p>  No big impact here except there’s less to port. The use of LINQ statements is an implementation detail, and there are easy equivalent implementations available on all common platforms. There’s nothing exotic being done here.</p>
</li>
<li><p>Conventions for state</p>
<p>  Inversion attempts to place mutable state in known places, and to keep state elsewhere as immutable and simple as possible. We’ve consolidated down our configuration to a single immutable structure, so a small nudge in the right direction.</p>
</li>
<li><p><em>Speed</em></p>
<p>  Performance tests are showing the same figures. There wasn’t expected to be any change here, move to backing configuration with arrays in the future may squeeze out some performance gains.</p>
</li>
<li><p><em>Other observations</em></p>
<p>  I’m starting to become mildly concerned over the use of LINQ methods used in a fluent style in implementation code. I have become aware of how often when debugging I am changing a linq statement into a simpler form in order to step through it and see what’s happening. I take this as a very loud warning sign. Often my use of linq is pure vanity as it has go-faster stripes. I think I’m going to start avoiding fluent chained statements, and expose the intermediary steps as local variables in order to make debugging easier… Difficult to force myself perhaps, as linq is bloody expressive.</p>
</li>
</ul>
<h2 id="Future_work">Future work</h2>
<p><em>TL;DR My flaky ideas.</em></p>
<p>There’s a couple of progressions I can see to this work, but first I want to let the existing work bed in before jumping the gun.</p>
<h3 id="Backing_the_configuration_elements_with_an_array">Backing the configuration elements with an array</h3>
<p>At the moment the <code>Configuration</code> is backed by <code>ImmutableHashSet&lt;IConfiguratonElement&gt;</code>. This is reasonably efficient, and is easy to work with. It could however be moved to being backed by an array:-</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">string</span>[][] config = <span class="keyword">new</span>[] {</div><div class="line">     <span class="keyword">new</span>[] {<span class="string">"frame1"</span>, <span class="string">"slot1"</span>, <span class="string">"name1"</span>, <span class="string">"value1"</span>},</div><div class="line">     <span class="keyword">new</span>[] {<span class="string">"frame2"</span>, <span class="string">"slot2"</span>, <span class="string">"name2"</span>, <span class="string">"value2"</span>}</div><div class="line">};</div></pre></td></tr></table></figure>

<p>Which would probably be more efficient.</p>
<p>I did it this way as it was easier to reason about and debug, and those are still valid reasons at the moment. Once it’s become part of the furniture, then I can think about trying this out.</p>
<h3 id="Expressing_tuples_relative_to_the_preceding_tuple">Expressing tuples relative to the preceding tuple</h3>
<p>There’s an improvement I can vaguely see… because the tuples are ordered, we can consider a new tuple as an expression relative to the previous tuple.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="operator">a</span>, b, c, d)</div><div class="line">((-<span class="number">2</span>), e, f) <span class="built_in">relative</span> <span class="built_in">to</span> <span class="operator">the</span> previous tuple =&gt; (<span class="operator">a</span>, b, e, f)</div><div class="line">((<span class="number">0</span>), g, h) becomes =&gt; (<span class="operator">a</span>, b, e, f, g, h)</div><div class="line">((-<span class="number">4</span>), x) becomes =&gt; (<span class="operator">a</span>, b, x)</div></pre></td></tr></table></figure>

<p>Relations of tuples include a lot of repetition in many cases. Using an expression of an offset from the end would allow us to express an uncapped arity of tuples with the limit being on how many new elements of a tuple we could expand by at a time. They could get effectively as large as you like… Think of scanning the list of tuple definitions using a stack as a point of context, you pop the specified amount of elements, and then push the rest on, the result is your current tuple. You could put this stack based iteration behind <code>IEnumerable&lt;IConfigurationElement&gt;</code> and anybody using it say via LINQ would be none the wiser.</p>
<p>My thinking on this is still fuzzy, and I feel it may be more than is required, possibly turning something quite straight-forward into something quite convoluted. Once I’ve thought through it a bit more, it may just be an obviously bad idea in practice. </p>
<p>Also sometimes a little constraint is an appropriate restraint. Time will tell.</p>
<h3 id="The_lookup_of_condition_predicates">The lookup of condition predicates</h3>
<p>As discussed, at the moment predicates to act on configuration are provided as extension methods which need to be used in conditions. The <code>frame</code> of a tuple could be used as a key to lookup the predicate to apply to it by a variety of mechanisms.</p>
<p>This would add extensibility but may be one indirection too far.</p>

      
    </div>
    <footer>
      
        
        
      
      
  
  <div class="tags">
    <a href="/tags/inversion/">inversion</a>, <a href="/tags/patterns/">patterns</a>
  </div>

      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Comments</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:guy-murphy.guthub.io">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/blog/">blog</a><small>1</small></li>
  
    <li><a href="/tags/inversion/">inversion</a><small>5</small></li>
  
    <li><a href="/tags/patterns/">patterns</a><small>5</small></li>
  
    <li><a href="/tags/practice/">practice</a><small>2</small></li>
  
    <li><a href="/tags/tools/">tools</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Guy Murphy
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'guy-murphy';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>